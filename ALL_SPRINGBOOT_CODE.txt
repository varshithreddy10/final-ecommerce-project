================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\docker-compose.yml ================
version: "3.8"

services:

  # ---------------- EUREKA SERVER ----------------
  eurekaserver:
    build: ./eurekaserver
    image: eurekaserver
    container_name: eurekaserver
    ports:
      - "8761:8761"
    networks:
      - ecommerce-network

  # ---------------- MICROSERVICE DB ----------------
  microservice-db:
    image: postgres:15
    container_name: microservice-db
    environment:
      POSTGRES_DB: microservicedb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - microservice-db-data:/var/lib/postgresql/data
    networks:
      - ecommerce-network

  # ---------------- SECURITY DB ----------------


  security-db:
    image: postgres:15
    container_name: security-db
    environment:
      POSTGRES_DB: securitydb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - security-db-data:/var/lib/postgresql/data
    networks:
      - ecommerce-network

  # ---------------- AUTH USER SERVICE ----------------
  authuser:
    build: ./authuser
    image: authuser
    container_name: authuser
    depends_on:
      - eurekaserver
      - security-db
    networks:
      - ecommerce-network


  # ---------------- ADMIN SERVICE ----------------
  adminapi:
    build: ./adminapi
    image: adminapi
    container_name: adminapi
    depends_on:
      - eurekaserver
      - microservice-db
    networks:
      - ecommerce-network


  # ---------------- CUSTOMER SERVICE ----------------
  customerapi:
    build: ./customerapi
    image: customerapi
    container_name: customerapi
    depends_on:
      - eurekaserver
      - microservice-db
    networks:
      - ecommerce-network


  # ---------------- PRODUCT SERVICE ----------------
  productapi:
    build: ./productapi
    image: productapi
    container_name: productapi
    depends_on:
      - eurekaserver
      - microservice-db
    networks:
      - ecommerce-network


  # ---------------- CART SERVICE ----------------
  cartapi:
    build: ./cartapi
    image: cartapi
    container_name: cartapi
    depends_on:
      - eurekaserver
      - microservice-db
    networks:
      - ecommerce-network


  # ---------------- ORDER SERVICE ----------------
  orderapi:
    build: ./orderapi
    image: orderapi
    container_name: orderapi
    depends_on:
      - eurekaserver
      - microservice-db
    networks:
      - ecommerce-network


  # ---------------- API GATEWAY ----------------
  apigateway:
    build: ./apigateway
    image: apigateway
    container_name: apigateway
    depends_on:
      - eurekaserver
      - authuser
      - adminapi
      - customerapi
      - productapi
      - cartapi
      - orderapi
    ports:
      - "8080:8080"
    networks:
      - ecommerce-network


volumes:
  microservice-db-data:
  security-db-data:

networks:
  ecommerce-network:

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 7002

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecom</groupId>
	<artifactId>adminapi</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>adminapi</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>


		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-actuator</artifactId>
		</dependency>

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.2.2</version>
		</dependency>

		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.13</version>
		</dependency>

		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-test</artifactId>
		<scope>test</scope>
		</dependency>


		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-brave</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin</artifactId>
		</dependency>
		<dependency>
			<groupId>io.micrometer</groupId>
			<artifactId>micrometer-tracing-bridge-brave</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>




	</dependencies>

	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\AdminapiApplication.java ================
package com.ecom.adminapi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
public class AdminapiApplication {

	public static void main(String[] args)
	{
		SpringApplication.run(AdminapiApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\config\MapperConfig.java ================
package com.ecom.adminapi.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MapperConfig
{
    @Bean
    public ModelMapper getMapper()
    {
        return new ModelMapper();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\controller\CategoryController.java ================
package com.ecom.adminapi.controller;

import com.ecom.adminapi.dto.CategoryDto;
import com.ecom.adminapi.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/admin")
public class CategoryController
{
    @Autowired
    private CategoryService categoryservice;

    @PostMapping("/add/category")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('CATEGORY_CREATE')")
    public ResponseEntity<CategoryDto> addCategory(@RequestBody CategoryDto categorydto)
    {
        CategoryDto categorydtosaved = categoryservice.createCategory(categorydto);
        return new ResponseEntity<>(categorydtosaved , HttpStatus.CREATED);
    }

    @GetMapping("/get/all/categories")
    @PreAuthorize("hasAnyRole('SELLER','USER','ADMIN') and hasAuthority('CATEGORY_VIEW')")
    public ResponseEntity<List<CategoryDto>> getAllCategories()
    {
        List<CategoryDto> allcategorydtos = categoryservice.getallCategory();
        return new ResponseEntity<>(allcategorydtos , HttpStatus.FOUND);
    }

    @GetMapping("/get/byid/{categoryId}")
    @PreAuthorize("hasAnyRole('SELLER','USER','ADMIN') and hasAuthority('CATEGORY_VIEW')")
    public ResponseEntity<CategoryDto> getCategorybyId(@PathVariable Long categoryId)
    {
        CategoryDto categorydto = categoryservice.getCategoryByIdserv(categoryId);
        return new ResponseEntity<>(categorydto , HttpStatus.FOUND);
    }

    @DeleteMapping("/delete/{categoryId}")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('CATEGORY_DELETE')")
    public ResponseEntity<String> deleteCategory(@PathVariable Long categoryId)
    {
        String message = categoryservice.deleteCategorybyId(categoryId);
        return new ResponseEntity<>(message , HttpStatus.GONE);
    }

    @PutMapping("/update/{categoryId}")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('CATEGORY_UPDATE')")
    public ResponseEntity<CategoryDto> updateCategory(@PathVariable Long categoryId , @RequestBody CategoryDto categorydto)
    {
        CategoryDto categorydtoupdated = categoryservice.updateCategoryserv(categorydto , categoryId);
        return new ResponseEntity<>(categorydtoupdated , HttpStatus.OK);
    }

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\dto\CategoryDto.java ================
package com.ecom.adminapi.dto;

import lombok.Data;

@Data
public class CategoryDto
{
    private Long categoryId;
    private String categoryName;

    private String active;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\entity\ProductCategory.java ================
package com.ecom.adminapi.entity;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
@Table(name = "productcategory")

public class ProductCategory
{
    //ProductCategory

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long categoryId;

    private String categoryName;

    private String active;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\exception\CompileTimeException.java ================
package com.ecom.adminapi.exception;

public class CompileTimeException extends Exception
{
    CompileTimeException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\exception\GenericApiException.java ================
package com.ecom.adminapi.exception;

public class GenericApiException extends RuntimeException
{
    GenericApiException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\exception\GlobalExceptionHandler.java ================
package com.ecom.adminapi.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler
{
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> myResourceNotFoundException(ResourceNotFoundException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(GenericApiException.class)
    public ResponseEntity<String> myGenericApiException(GenericApiException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(CompileTimeException.class)
    public ResponseEntity<String> myCompileTimeException(CompileTimeException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<String> myValidationError(MethodArgumentNotValidException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> myException(Exception e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\exception\ResourceNotFoundException.java ================
package com.ecom.adminapi.exception;

import org.springframework.web.bind.annotation.RestControllerAdvice;


public class ResourceNotFoundException extends RuntimeException
{
    String resourceName;
    String field;
    String fieldName;
    Integer fieldId;

    public ResourceNotFoundException() {
    }

    public ResourceNotFoundException(String resourceName, String field, String fieldName) {
        super(String.format("%s not found with %s: %s", resourceName, field, fieldName));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldName = fieldName;
    }

    public ResourceNotFoundException(String resourceName, String field, Integer fieldId) {
        super(String.format("%s not found with %s: %d", resourceName, field, fieldId));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldId = fieldId;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\repository\CategoryRepository.java ================
package com.ecom.adminapi.repository;


import com.ecom.adminapi.entity.ProductCategory;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CategoryRepository extends JpaRepository<ProductCategory, Long>
{
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\service\CategoryService.java ================
package com.ecom.adminapi.service;

import com.ecom.adminapi.dto.CategoryDto;

import java.util.List;

public interface CategoryService 
{
    
    public CategoryDto createCategory(CategoryDto categorydto);

    public List<CategoryDto> getallCategory();

    CategoryDto getCategoryByIdserv(Long categoryId);

    String deleteCategorybyId(Long categoryId);

    CategoryDto updateCategoryserv(CategoryDto categorydto , Long categoryId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\service\CategoryServiceImpl.java ================
package com.ecom.adminapi.service;

import com.ecom.adminapi.dto.CategoryDto;
import com.ecom.adminapi.entity.ProductCategory;
import com.ecom.adminapi.exception.ResourceNotFoundException;
import com.ecom.adminapi.repository.CategoryRepository;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class CategoryServiceImpl implements CategoryService
{
   @Autowired
   private ModelMapper modelmapper;

   @Autowired
   private CategoryRepository catrepo;


    @Override
    public CategoryDto createCategory(CategoryDto categorydto)
    {
        //1.check if category is already present or not by using name
        //2.convert categorydto to entity and save in repo
        //3.convert savedcategoryentity to dto and return

        ProductCategory categoryentity = modelmapper.map(categorydto , ProductCategory.class);
        ProductCategory savedcaterory = catrepo.save(categoryentity);

        return modelmapper.map(savedcaterory , CategoryDto.class);
    }

    @Override
    public List<CategoryDto> getallCategory()
    {
        List<ProductCategory> allcategoryentity = catrepo.findAll();
        List<CategoryDto> allcategorydtos=allcategoryentity.stream()
                .map(individualCategoryentity -> modelmapper.map(individualCategoryentity , CategoryDto.class))
                .toList();
        return allcategorydtos;
    }

    @Override
    public CategoryDto getCategoryByIdserv(Long categoryId)
    {
        /*
            1.check if category exists or not with id if not throw a exception
            2.if present fetch and return
         */

        ProductCategory categoryentity = catrepo.findById(categoryId)
                .orElseThrow(()-> new ResourceNotFoundException("category","categoryId",""+categoryId));

        CategoryDto categorydto = modelmapper.map(categoryentity , CategoryDto.class);
        return categorydto;
    }

    @Override
    public String deleteCategorybyId(Long categoryId)
    {
        ProductCategory categoryentity = catrepo.findById(categoryId)
                .orElseThrow(()-> new ResourceNotFoundException("category","categoryId",""+categoryId));
        catrepo.deleteById(categoryId);
        return "success";
    }

    @Override
    public CategoryDto updateCategoryserv(CategoryDto categorydto , Long categoryId)
    {
        ProductCategory categoryentity = catrepo.findById(categoryId)
                .orElseThrow(()-> new ResourceNotFoundException("category","categoryId",""+categoryId));

        categoryentity.setActive(categorydto.getActive());
        categoryentity.setCategoryName(categorydto.getCategoryName());

        ProductCategory savedcategoryentity = catrepo.save(categoryentity);

        return modelmapper.map(savedcategoryentity , CategoryDto.class);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\springsecurity\config\SecurityConfig.java ================
package com.ecom.adminapi.springsecurity.config;


import com.ecom.adminapi.springsecurity.filter.GatewayAuthenticationFilter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Slf4j
@EnableMethodSecurity(prePostEnabled = true)
@Configuration
public class SecurityConfig
{
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, GatewayAuthenticationFilter gatewayAuthenticationFilter) throws Exception
    {
        log.info("NATALIE control entered securityFilterChain ");
            http.csrf(csrf -> csrf.disable())
                .sessionManagement(sm ->
                                           sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS) )
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(gatewayAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

            return http.build();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\java\com\ecom\adminapi\springsecurity\filter\GatewayAuthenticationFilter.java ================
package com.ecom.adminapi.springsecurity.filter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Component
public class GatewayAuthenticationFilter extends OncePerRequestFilter
{
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException
    {
        log.info("NATALIE control entered doFilterInternal");

        String userId = request.getHeader("X-User-Id");
        log.info("NATALIE control entered doFilterInternal");

        String authoritiesHeader = request.getHeader("X-User-Authorities");
        log.info("NATALIE control entered doFilterInternal");

        if (userId != null && authoritiesHeader != null)
        {
            /*
            List<SimpleGrantedAuthority> authorities =
                    Arrays.stream(authoritiesHeader.split(","))
                            .map(String::trim)
                            .map(SimpleGrantedAuthority::new)
                            .toList();
             */
            List<SimpleGrantedAuthority> authorities = new ArrayList<>();

            String[] authorityArray = authoritiesHeader.split(",");

            for (String authority : authorityArray) {
                String cleaned = authority.trim();
                SimpleGrantedAuthority grantedAuthority =
                        new SimpleGrantedAuthority(cleaned);

                authorities.add(grantedAuthority);
            }


            log.info("NATALIE List<SimpleGrantedAuthority> authorities = "+authorities);

            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userId, null, authorities);
            log.info("NATALIE authentication object created is = "+authentication);

            SecurityContextHolder.getContext().setAuthentication(authentication);
            log.info("NATALIE execution of doFilterInternal is completed and authentiction object in the securitycontextholder is ="+SecurityContextHolder.getContext().getAuthentication());

        }
        filterChain.doFilter(request, response);

    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\main\resources\application.properties ================
spring.application.name=adminapi




# ===============================
# DATABASE (PostgreSQL - Docker)
# ===============================
spring.datasource.url=jdbc:postgresql://microservice-db:5432/microservicedb
spring.datasource.username=user
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

server.port=7002

eureka.instance.prefer-ip-address=true

eureka.client.service-url.defaultZone=http://eurekaserver:8761/eureka

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\adminapi\src\test\java\com\ecom\adminapi\AdminapiApplicationTests.java ================
package com.ecom.adminapi;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AdminapiApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecommerce</groupId>
	<artifactId>apigateway</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>apigateway</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-brave</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-actuator</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin</artifactId>
		</dependency>
		<dependency>
			<groupId>io.micrometer</groupId>
			<artifactId>micrometer-tracing-bridge-brave</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway-server-webflux</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>io.projectreactor</groupId>
			<artifactId>reactor-test</artifactId>
			<scope>test</scope>
		</dependency>

		<!-- JWT -->
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.12.6</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.12.6</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.12.6</version>
			<scope>runtime</scope>
		</dependency>


	</dependencies>
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>



	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\src\main\java\com\ecommerce\apigateway\ApigatewayApplication.java ================
package com.ecommerce.apigateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class ApigatewayApplication {

	public static void main(String[] args) {
		SpringApplication.run(ApigatewayApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\src\main\java\com\ecommerce\apigateway\filters\AuthenticationFilter.java ================
package com.ecommerce.apigateway.filters;


import com.ecommerce.apigateway.service.JwtService;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;

import java.util.List;

@Slf4j
@Component
public class AuthenticationFilter extends AbstractGatewayFilterFactory<AuthenticationFilter.Config>
{

    private final JwtService jwtService;

    public AuthenticationFilter(JwtService jwtService)
    {
        super(Config.class);
        this.jwtService = jwtService;
    }

    @Override
    public GatewayFilter apply(Config config)
    {
        log.info("PORTMAN control entered the AuthenticationFilter ");
        return (exchange, chain) -> {

            String authHeader = exchange.getRequest().getHeaders().getFirst("Authorization");

            log.info("NATALIE jwttoken is = "+authHeader);

            if (authHeader == null || !authHeader.startsWith("Bearer "))
            {

                exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
                log.info("NATALIE control entered the if-else and the message is "+exchange.getResponse().setComplete());
                return exchange.getResponse().setComplete();
            }

            String token = authHeader.substring(7);

            try
            {
                Claims claims = jwtService.validateAndGetClaims(token);
                log.info("NATALIE claims are  = "+claims);

                String userId = claims.getSubject();
                log.info("NATALIE userId is  = "+userId);

                String email = claims.get("email",String.class);
                log.info("NATALIE email = "+email);


                List<String> rolesSet = claims.get("rolesset", List.class);
                log.info("NATALIE rolesset are  = "+rolesSet);

                List<String> rolesString = claims.get("rolesstring", List.class);
                log.info("NATALIE rolesString are  = "+rolesString);

                List<String> athoritiesOfUser = claims.get("authorities", List.class);
                log.info("NATALIE athoritiesOfUser are  = "+athoritiesOfUser);

                ServerWebExchange modifiedExchange =
                        exchange.mutate()
                                .request(req -> req
                                        .header("X-User-Id", userId)
                                        .header("X-User-RoleSet",String.join(",",rolesSet))
                                        .header("X-User-Roles", String.join(",", rolesString))
                                        .header("X-User-Authorities", String.join(",", athoritiesOfUser))
                                )
                                .build();
                log.info("NATALIE ServerWebExchange modifiedExchange = "+modifiedExchange);

                return chain.filter(modifiedExchange);

            }
            catch (Exception e)
            {
                exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
                log.error("exception occured and the  1 error is "+e.getMessage());
                log.error("exception occured and the  2 error is "); //+exchange.getResponse().setComplete()

                return exchange.getResponse().setComplete();
            }
        };
    }

    public static class Config
    {

    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\src\main\java\com\ecommerce\apigateway\service\JwtService.java ================
package com.ecommerce.apigateway.service;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;

@Service
@Slf4j
public class JwtService {


    private String jwtSecret="ads9f6askj3h4k1hf86asdfiahkjh34a789s6df89ayshkjh3jkh786adsf78ay";

    private SecretKey getKey()
    {
        return Keys.hmacShaKeyFor(jwtSecret.getBytes(StandardCharsets.UTF_8));
    }

    public Claims validateAndGetClaims(String token)
    {
        log.info("NATALIE control entered the validateAndGetClaims");
        Claims claims =  Jwts.parser()
                .verifyWith(getKey())
                .build()
                .parseSignedClaims(token)
                .getPayload();
        log.info("NATALIE execution of  validateAndGetClaims is completed and the claims are = "+claims);
        return claims;
    }
}


================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\src\main\resources\application.yml ================



spring:
  application:
    name: apigateway

  cloud:
    gateway:
      server:
        webflux:
          routes:

            - id: auth-service
              uri: lb://AUTHUSER
              predicates:
                - Path=/api/auth/**

            - id: order-service
              uri: lb://orderapi
              predicates:
                - Path=/api/orders/**
              filters:
                - name: AuthenticationFilter


            - id: customer-service
              uri: lb://customerapi
              predicates:
                - Path=/api/customer/**
              filters:
                - name: AuthenticationFilter


            - id: address-service
              uri: lb://customerapi
              predicates:
                - Path=/api/address/**
              filters:
                - name: AuthenticationFilter


            - id: cart-service
              uri: lb://cartapi
              predicates:
                - Path=/api/carts/**
              filters:
                - name: AuthenticationFilter


            - id: product-service
              uri: lb://PRODUCTAPI
              predicates:
                - Path=/api/products/**
              filters:
                - name: AuthenticationFilter


            - id: admin-service
              uri: lb://adminapi
              predicates:
                - Path=/api/admin/**
              filters:
                - name: AuthenticationFilter

server:
  port: 8080

eureka:
  client:
    service-url:
      defaultZone: http://eurekaserver:8761/eureka



================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\apigateway\src\test\java\com\ecommerce\apigateway\ApigatewayApplicationTests.java ================
package com.ecommerce.apigateway;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ApigatewayApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 5000

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecommerce</groupId>
	<artifactId>authuser</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>authuser</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>

		<!-- BCrypt only -->
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-crypto</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>



		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>


		<!-- TESTING -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>



		<!-- MODELMAPPER -->
		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.2.0</version>
		</dependency>

		<!-- TESTING -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>


		<!-- JWT -->
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.12.6</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.12.6</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.12.6</version>
			<scope>runtime</scope>
		</dependency>

		<!-- https://mvnrepository.com/artifact/org.springdoc/springdoc-openapi-starter-webmvc-ui -->
		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>3.0.1</version>
		</dependency>

		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>


	</dependencies>


	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>

		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\AuthuserApplication.java ================
package com.ecommerce.authuser;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
public class AuthuserApplication {

	public static void main(String[] args) {
		SpringApplication.run(AuthuserApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\config\GetModelMapper.java ================
package com.ecommerce.authuser.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class GetModelMapper
{
    @Bean
    public ModelMapper getmyModelMapper()
    {
        return new ModelMapper();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\controller\AuthController.java ================
package com.ecommerce.authuser.controller;



import com.ecommerce.authuser.dto.LoginDto;
import com.ecommerce.authuser.dto.LoginResponseDto;
import com.ecommerce.authuser.dto.SignUpDto;
import com.ecommerce.authuser.dto.UserDto;
import com.ecommerce.authuser.springsecurity.securityservice.AuthService;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;


@Slf4j
@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController
{


    private final AuthService authService;



    @PostMapping("/signup")
    public ResponseEntity<UserDto> signUp(@RequestBody SignUpDto signUpDto)
    {
        log.info("control entered the signup in the authcontroller with the signupdto "+signUpDto);
        UserDto userDto = authService.signUp(signUpDto);
        log.info("execution of the signup is completed and the response is "+signUpDto);

        return new ResponseEntity<>(userDto , HttpStatus.OK);
    }

    @PostMapping("/login")
    public ResponseEntity<LoginResponseDto> login(@RequestBody LoginDto loginDto, HttpServletRequest request,
                                                  HttpServletResponse response)
    {


        log.info("control entered the login method in the controller using the logindto "+loginDto);
        LoginResponseDto loginResponseDto = authService.login(loginDto);
        log.info("execution of the login method is completed and the response is "+loginResponseDto);
        System.out.println("====================================================================================================================================================================================================================================");

        return new ResponseEntity<>(loginResponseDto , HttpStatus.OK);
    }

    @GetMapping("/test")
    public ResponseEntity<String> test()
    {
        String message = "varshith docker container has successfully started authuser";

        return new ResponseEntity<>(message , HttpStatus.OK);
    }


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\dto\CustomerCreateDto.java ================
package com.ecommerce.authuser.dto;


import com.ecommerce.authuser.enums.Role;
import lombok.Data;

import java.util.Set;

@Data
public class CustomerCreateDto
{
    private Long customerId;
    private String name;
    private String email;
    private String phoneNo;

    private Set<Role> roles;

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\dto\LoginDto.java ================
package com.ecommerce.authuser.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class LoginDto {
    String email;
    String password;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\dto\LoginResponseDto.java ================
package com.ecommerce.authuser.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@NoArgsConstructor
@AllArgsConstructor
@Data
public class LoginResponseDto {

    private Long id;
    private String accessToken;

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\dto\PostDTO.java ================
package com.ecommerce.authuser.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class PostDTO {
    private Long id;
    private String title;
    private String description;

    private UserDto author;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\dto\SignUpDto.java ================
package com.ecommerce.authuser.dto;




import com.ecommerce.authuser.enums.Role;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Set;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class SignUpDto
{
    private Long customerId;
    private String name;
    private String email;
    private String phoneNo;

    private String password;

    private Set<Role> roles;

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\dto\UserDto.java ================
package com.ecommerce.authuser.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class UserDto {

    private Long id;
    private String email;
    private String name;

    private LocalDate dateCreated;
    private LocalDate lastUpdated;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\entity\UserEntity.java ================
package com.ecommerce.authuser.entity;


import com.ecommerce.authuser.enums.Role;
import com.ecommerce.authuser.springsecurity.securityconfig.PermissionMapping;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import lombok.extern.slf4j.Slf4j;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDate;
import java.util.HashSet;
import java.util.Set;

@Entity
@Getter
@Setter
@ToString
@Slf4j
public class UserEntity
{

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long customerId;
    private String name;
    private String email;
    private String phoneNo;

    private String password;


    @ElementCollection(fetch = FetchType.EAGER)
    @Enumerated(EnumType.STRING)
    private Set<Role> roles;

    @CreationTimestamp
    @Column(name="date_created", updatable = false)
    private LocalDate dateCreated;

    @UpdateTimestamp
    @Column(name="last_updated", insertable = false)
    private LocalDate lastUpdated;

    /**
     * Builds authorities as plain Strings:
     * ROLE_* + permission names
     */
    public Set<String> getAuthorities()
    {
        Set<String> authorities = new HashSet<>();

        for (Role individualrole : roles)
        {
            authorities.add("ROLE_" + individualrole.name());
            authorities.addAll(PermissionMapping.getAuthoritiesForRole(individualrole));
        }
        return authorities;
    }

    /*public Set<String> getAuthorities()
    {
        Set<String> authorities = new HashSet<>();
        roles.forEach(individualrole->{
            Set<String> permissions = PermissionMapping.getAuthoritiesForRole(individualrole);
            authorities.addAll(permissions);
            authorities.add("ROLE_"+individualrole);
        });

        return authorities;

    }*/

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\enums\Permission.java ================
package com.ecommerce.authuser.enums;

public enum Permission
{
    /* ================= USER ================= */
    USER_VIEW, USER_CREATE, USER_UPDATE, USER_DELETE, USER_VIEW_ALL,

    /* ================= ADDRESS ================= */
    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,

    /* ================= PRODUCT ================= */
    PRODUCT_VIEW, PRODUCT_CREATE,PRODUCT_UPDATE, PRODUCT_DELETE,

    /* ================= CATEGORY ================= */
    CATEGORY_VIEW, CATEGORY_CREATE, CATEGORY_UPDATE, CATEGORY_DELETE,

    /* ================= ORDER ================= */
    ORDER_VIEW, ORDER_CREATE, ORDER_UPDATE, ORDER_CANCEL, ORDER_VIEW_ALL,

    /* ================= CART ================= */
    CART_VIEW, CART_ADD_ITEM, CART_REMOVE_ITEM, CART_CLEAR, CART_VIEW_ALL,

    /* ================= PAYMENT ================= */
    PAYMENT_INITIATE, PAYMENT_VIEW,

    /* ================= INVENTORY ================= */
    INVENTORY_VIEW, INVENTORY_UPDATE
}


================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\enums\Role.java ================
package com.ecommerce.authuser.enums;

public enum Role
{
    USER,
    SELLER,
    ADMIN,
    NORMAL
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\Exception\CustomerIdNotMatchException.java ================
package com.ecommerce.authuser.Exception;

public class CustomerIdNotMatchException extends  RuntimeException
{
    private String message;
    public CustomerIdNotMatchException(String message)
    {
        super(message);
        this.message=message;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\Exception\MyGlobalExceptionHandler.java ================
package com.ecommerce.authuser.Exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class MyGlobalExceptionHandler
{
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> handleResourceNotFoundException(ResourceNotFoundException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message, HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(CustomerIdNotMatchException.class)
    public ResponseEntity<String> CustomerIdNotMatchExceptions(CustomerIdNotMatchException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message, HttpStatus.BAD_REQUEST);
    }





}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\Exception\ResourceNotFoundException.java ================
package com.ecommerce.authuser.Exception;

public class ResourceNotFoundException extends RuntimeException
{
    private String message;
    public ResourceNotFoundException(String message)
    {
        super(message);
        this.message=message;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\feignclients\Customer_Api_Feignclient.java ================
package com.ecommerce.authuser.feignclients;


import com.ecommerce.authuser.dto.CustomerCreateDto;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

@FeignClient(name = "CUSTOMERAPI")
public interface Customer_Api_Feignclient
{
    @PostMapping("/api/customer/add/customer")
    CustomerCreateDto createCustomer(@RequestBody CustomerCreateDto customercreatedto);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\repository\UserRepository.java ================
package com.ecommerce.authuser.repository;


import com.ecommerce.authuser.entity.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<UserEntity,Long> {
    Optional<UserEntity> findByEmail(String email);

    Optional<UserEntity> findByName(String name);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\springsecurity\interceptor\FeinClientInterceptor.java ================
package com.ecommerce.authuser.springsecurity.interceptor;

import feign.RequestInterceptor;
import feign.RequestTemplate;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.List;


@Slf4j
@Component
public class FeinClientInterceptor implements RequestInterceptor
{

    @Override
    public void apply(RequestTemplate requestTemplate)
    {
            log.info("NATALIE control entered the FeinClientInterceptor");

            requestTemplate.header("X-User-Id", "50");

            List<String> authoritiesOfUser = List.of("ROLE_USER" ,"ROLE_ADMIN","ROLE_SELLER");


            //  Joining authorities using comma
            String authoritiesHeader = String.join(",", authoritiesOfUser);
            log.info("NATALIE converting Set<String> to string "+authoritiesHeader);

            // Adding header
            requestTemplate.header("X-User-Authorities", authoritiesHeader);

        //requestTemplate.header("X-User-Create", "CREATING_NEW_USER");
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\springsecurity\securityconfig\AppConfig.java ================
package com.ecommerce.authuser.springsecurity.securityconfig;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class AppConfig
{
    //private final BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();

    @Bean
    PasswordEncoder passwordEncoder()
    {
        return new BCryptPasswordEncoder();
    }

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\springsecurity\securityconfig\PermissionMapping.java ================
package com.ecommerce.authuser.springsecurity.securityconfig;



import com.ecommerce.authuser.enums.Permission;
import com.ecommerce.authuser.enums.Role;
import lombok.extern.slf4j.Slf4j;

import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import static com.ecommerce.authuser.enums.Permission.*;
import static com.ecommerce.authuser.enums.Role.*;


@Slf4j
public class PermissionMapping
{
    /*private static final Map<Role, Set<Permission>> map = Map.of(
            USER, Set.of(USER_VIEW, POST_VIEW),
            SELLER, Set.of(POST_CREATE, USER_UPDATE, POST_UPDATE),
            ADMIN, Set.of(POST_CREATE, USER_UPDATE, POST_UPDATE, USER_DELETE, USER_CREATE, POST_DELETE)
    );*/

    private static final Map<Role, Set<Permission>> map = Map.of(

            /* ================= CUSTOMER ================= */
            USER, Set.of(
                    USER_VIEW, USER_UPDATE,
                    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,
                    PRODUCT_VIEW, CATEGORY_VIEW,
                    CART_VIEW, CART_ADD_ITEM, CART_REMOVE_ITEM, CART_CLEAR,
                    ORDER_CREATE, ORDER_VIEW, ORDER_CANCEL,
                    PAYMENT_INITIATE, PAYMENT_VIEW
            ),

            /* ================= SELLER ================= */
            SELLER, Set.of(
                    USER_VIEW, USER_UPDATE,
                    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,
                    PRODUCT_VIEW, PRODUCT_CREATE, PRODUCT_UPDATE,
                    CATEGORY_VIEW,
                    INVENTORY_VIEW, INVENTORY_UPDATE,
                    ORDER_VIEW
            ),

            /* ================= ADMIN ================= */
            ADMIN, Set.of(
                    USER_VIEW, USER_VIEW_ALL, USER_CREATE, USER_UPDATE, USER_DELETE,
                    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,
                    PRODUCT_VIEW, PRODUCT_CREATE, PRODUCT_UPDATE, PRODUCT_DELETE,
                    CATEGORY_VIEW, CATEGORY_CREATE, CATEGORY_UPDATE, CATEGORY_DELETE,
                    CART_VIEW, CART_VIEW_ALL, ORDER_VIEW,
                    ORDER_UPDATE, ORDER_VIEW_ALL, ORDER_CANCEL,
                    INVENTORY_VIEW, INVENTORY_UPDATE,
                    PAYMENT_VIEW

            )
    );

    public static Set<String> getAuthoritiesForRole(Role role)
    {
        log.info("PermissionMapping â†’ resolving permissions for role {}", role);

         Set<String> authorities  =  map.getOrDefault(role, Set.of())
                                        .stream()
                                        .map(Permission::name)
                                        .collect(Collectors.toSet());
        return authorities;
    }

  /*  public static Set<String> getAuthoritiesForRole(Role role)
    {

        Set<String> allpermissions = map.get(role).stream()
                .map(permission -> permission))
                .collect(Collectors.toSet());

        return allpermissions;
    }

    public static Set<String> getAuthoritiesForRole(Role roles)
    {


        Set<String> authorities = new HashSet<>();

        for (Role role : roles) {
            // ROLE authority
            authorities.add("ROLE_" + role.name());

            // Permission authorities
            ROLE_PERMISSION_MAP
                    .getOrDefault(role, Set.of())
                    .forEach(p -> authorities.add(p.name()));
        }

        return authorities;
    }
*/

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\springsecurity\securityservice\AuthService.java ================
package com.ecommerce.authuser.springsecurity.securityservice;


import com.ecommerce.authuser.Exception.CustomerIdNotMatchException;
import com.ecommerce.authuser.Exception.ResourceNotFoundException;
import com.ecommerce.authuser.dto.*;
import com.ecommerce.authuser.entity.UserEntity;

import com.ecommerce.authuser.feignclients.Customer_Api_Feignclient;
import com.ecommerce.authuser.repository.UserRepository;
import lombok.extern.slf4j.Slf4j;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Slf4j
@Service
public class AuthService
{
    @Autowired
    private UserRepository userrepo;

    @Autowired
    private ModelMapper modelmapper;

    @Autowired
    private PasswordEncoder passwordencoder;

    @Autowired
    private JwtService jwtservice;

    @Autowired
    private Customer_Api_Feignclient customerfeign;


    public Boolean creatingCustomerInCustomerService(UserEntity savedUser)
    {
        boolean result;
        log.info("NATALIE control entered the creatingCustomerInCustomerService with userentity = "+savedUser);

        CustomerCreateDto customercreatedto = modelmapper.map(savedUser , CustomerCreateDto.class);
        log.info("NATALIE converting the UserEntity to CustomerCreateDto = "+customercreatedto);

        try
        {
            CustomerCreateDto createdcustomer = customerfeign.createCustomer(customercreatedto);
            log.info("NATALIE saved customer in the customer-service is = "+createdcustomer);

            if(!savedUser.getCustomerId().equals(createdcustomer.getCustomerId()))
            {
                throw new CustomerIdNotMatchException("customerId's in the auth-service = "+savedUser.getCustomerId()+" and the Customer-service = "+createdcustomer.getCustomerId()+" doesnot match");
            }
            else
            {
                log.info("both the ids are matched savedUser.getCustomerId() = "+savedUser.getCustomerId()+" == createdcustomer.getCustomerId() = "+createdcustomer.getCustomerId());
            }

            result=true;
        }
        catch(Exception e)
        {

            result = false;
            log.error("NATALIE exception occured while creating customer in customer-service "+e.getMessage());
            userrepo.deleteById(savedUser.getCustomerId());
            log.info("creation of the user is failed in customer-service so we are deleting the user-entity from the database ");
        }

        return result;

    }

    public UserDto signUp(SignUpDto signUpDto)
    {
        log.info("control entered the signup() method with signupdto as "+signUpDto);
        Optional<UserEntity> user = userrepo.findByEmail(signUpDto.getEmail());
        if(user.isPresent())
        {
            throw new ResourceNotFoundException("User with email already exits "+ signUpDto.getEmail());
        }

        UserEntity toBeCreatedUser = modelmapper.map(signUpDto, UserEntity.class);
        toBeCreatedUser.setPassword(passwordencoder.encode(toBeCreatedUser.getPassword()));

        log.info("before saving userentity = "+toBeCreatedUser);

        UserEntity savedUser = userrepo.save(toBeCreatedUser);

        log.info("execution of the signup is completed and the saved user is "+savedUser);

        /*
           id is generated after saving in the database so saving the user in auth-service repo
           after saving extract the user from database and send them to the customer-service to create a new user
         */

        if(creatingCustomerInCustomerService(savedUser)==false)
        {
            return null;
        }

        return modelmapper.map(savedUser, UserDto.class);
    }

    public LoginResponseDto login(LoginDto dto) {

        UserEntity user = userrepo.findByEmail(dto.getEmail())
                .orElseThrow(() -> new RuntimeException("User not found"));

        if (!passwordencoder.matches(dto.getPassword(), user.getPassword()))
        {
            throw new RuntimeException("Invalid password");
        }

        String token = jwtservice.generateAccessToken(user);

        return new LoginResponseDto(user.getCustomerId(), token);
    }






}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\java\com\ecommerce\authuser\springsecurity\securityservice\JwtService.java ================
package com.ecommerce.authuser.springsecurity.securityservice;


import com.ecommerce.authuser.entity.UserEntity;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Service
@Slf4j
public class JwtService
{
   private static String jwtsecret = "ads9f6askj3h4k1hf86asdfiahkjh34a789s6df89ayshkjh3jkh786adsf78ay";

   private SecretKey getJwtSecret()
   {
       log.info("getting the secretkey");
       return Keys.hmacShaKeyFor(jwtsecret.getBytes(StandardCharsets.UTF_8));
   }

    public String generateAccessToken(UserEntity user)
    {


    /*    // Convert GrantedAuthority â†’ List<String>
        List<String> authorities = user.getAuthorities()
                .stream()
                .map(GrantedAuthority::getAuthority)
                .toList();
                */

        List<String> roles = user.getRoles()
                .stream()
                .map(role -> "ROLE_" + role.name())
                .toList();

        List<String> authorities = new ArrayList<>(user.getAuthorities());



        return Jwts.builder()
                .subject(user.getCustomerId().toString())
                .claim("email", user.getEmail())
                .claim("rolesset", user.getRoles())
                .claim("rolesstring",roles)
                .claim("authorities", authorities)
                .issuedAt(new Date())
                .expiration(new Date(System.currentTimeMillis() + 1000 * 60 * 10))
                .signWith(getJwtSecret())
                .compact();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\main\resources\application.properties ================
spring.application.name=authuser



# ===============================
# DATABASE (PostgreSQL - Docker)
# ===============================
spring.datasource.url=jdbc:postgresql://security-db:5432/securitydb
spring.datasource.username=user
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

server.port=5000

logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.security.web.context=DEBUG

eureka.client.service-url.defaultZone=http://eurekaserver:8761/eureka

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\authuser\src\test\java\com\ecommerce\authuser\AuthuserApplicationTests.java ================
package com.ecommerce.authuser;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AuthuserApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 7004

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecom</groupId>
	<artifactId>cartapi</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>cartapi</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>

		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>



		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-actuator</artifactId>
		</dependency>

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.2.2</version>
		</dependency>

		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.13</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>


		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-brave</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin</artifactId>
		</dependency>
		<dependency>
			<groupId>io.micrometer</groupId>
			<artifactId>micrometer-tracing-bridge-brave</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>





	</dependencies>

	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\CartapiApplication.java ================
package com.ecom.cartapi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
public class CartapiApplication {

	public static void main(String[] args) {
		SpringApplication.run(CartapiApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\config\MapperConfig.java ================
package com.ecom.cartapi.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MapperConfig
{
    @Bean
    public ModelMapper getMapper()
    {
        return new ModelMapper();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\controller\CartController.java ================
package com.ecom.cartapi.controller;

import com.ecom.cartapi.dto.CartDto;
import com.ecom.cartapi.service.CartService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/carts")
public class CartController
{
    @Autowired
    private CartService cartservice;

    @PostMapping("/carts/products/{productId}/quantity/{quantity}/customer/{customerId}")
    @PreAuthorize("hasRole('USER') and hasAuthority('CART_ADD_ITEM')")
    public ResponseEntity<CartDto> addProductToCart(@PathVariable Long productId , @PathVariable Integer quantity , @PathVariable Long customerId)
    {
        CartDto cartdto = cartservice.addProductToCartServ(productId , quantity , customerId);
        return new ResponseEntity<>(cartdto , HttpStatus.CREATED);
    }

    @GetMapping("/carts")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('CART_VIEW) and hasAuthority('CART_VIEW_ALL')")
    public ResponseEntity<List<CartDto>> getAllCarts()
    {
        List<CartDto> allcartdto = cartservice.getAllCartsServ();
        return new ResponseEntity<>(allcartdto , HttpStatus.CREATED);
    }

    @GetMapping("/get/cart/{customerId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('CART_VIEW')")
    public  ResponseEntity<CartDto> getCustomerCart(@PathVariable Long customerId)
    {
        CartDto cartdto = cartservice.getCustomerCartServ(customerId);
        return new ResponseEntity<>(cartdto , HttpStatus.FOUND);
    }

    @DeleteMapping("/delete/{cartId}")
    @PreAuthorize("hasRole('USER') and hasAuthority('CART_CLEAR')")
    public ResponseEntity<String> deleteCustomerCart(@PathVariable Long cartId)
    {
        String message = cartservice.deleteCustomerCartserv(cartId);
        return new ResponseEntity<>(message , HttpStatus.OK);
    }

    @DeleteMapping("/delete/{cartId}/{productId}")
    @PreAuthorize("hasRole('USER') and hasAuthority('CART_REMOVE_ITEM')")
    public ResponseEntity<CartDto> deleteProductfronCart(@PathVariable Long cartId , @PathVariable Long productId)
    {
        CartDto cartdto= cartservice.deleteProductFromCart(cartId , productId);
        return new ResponseEntity<>(cartdto , HttpStatus.OK);
    }


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\dto\AddressDto.java ================
package com.ecom.cartapi.dto;

import lombok.Data;

@Data
public class AddressDto
{
    private Long addrId;
    private String hno;
    private String street;
    private String city;
    private String state;
    private String zipCode;
    private String addrType;
    private String deleteSw;

    //private CustomerEntity customer;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\dto\CartDto.java ================
package com.ecom.cartapi.dto;

import com.ecom.cartapi.entity.CartItemEntity;
import com.ecom.cartapi.entity.CustomerEntity;
import com.fasterxml.jackson.annotation.JsonManagedReference;
import jakarta.persistence.CascadeType;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.OneToMany;
import jakarta.persistence.OneToOne;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

@Data
public class CartDto
{
    private Long cartId;
    private CustomerEntity user;
    private List<CartItemEntity> cartitem = new ArrayList<>();
    private Double totalPrice;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\dto\CartItemDto.java ================
package com.ecom.cartapi.dto;

import com.ecom.cartapi.entity.CartEntity;
import com.ecom.cartapi.entity.ProductEntity;
import lombok.Data;

@Data
public class CartItemDto
{
    private Long Id;
    private ProductEntity product;
    private CartEntity cart;
    private Integer quantity;
    private double discount;
    private double productPrice;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\dto\CustomerDto.java ================
package com.ecom.cartapi.dto;

import lombok.Data;

import java.time.LocalDate;

@Data
public class CustomerDto
{
    private Long customerId;
    private String name;
    private String email;
    private String password;
    private String pwdUpdated;
    private String phoneNo;

    private LocalDate dateCreated;

    private LocalDate lastUpdated;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\dto\ProductDto.java ================
package com.ecom.cartapi.dto;

import lombok.Data;

import java.time.LocalDate;

@Data
public class ProductDto
{
    private Long productId;
    private String name;
    private String description;
    private String title;
    private Double unitPrice;
    private String imageUrl;
    private boolean active;
    private int unitsInStock;

    private LocalDate dateCreated;
    private LocalDate lastUpdated;

    //private ProductCategory category;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\entity\CartEntity.java ================
package com.ecom.cartapi.entity;

import com.fasterxml.jackson.annotation.JsonManagedReference;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

import java.util.ArrayList;
import java.util.List;

@Getter
@Setter
@Entity
@Table(name =("cartentity"))
public class CartEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long cartId;

    @OneToOne
    @JoinColumn(name = "user_id")
    private CustomerEntity user;

    @OneToMany(mappedBy = "cart",
            cascade = {CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REMOVE},
            orphanRemoval = true)
    @JsonManagedReference
    private List<CartItemEntity> cartitem = new ArrayList<>();

    private Double totalPrice;

    public  void setCartitems(CartItemEntity cartitems)
    {
        cartitem.add(cartitems);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\entity\CartItemEntity.java ================
package com.ecom.cartapi.entity;

import com.fasterxml.jackson.annotation.JsonBackReference;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
public class CartItemEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long Id;

    @ManyToOne
    @JoinColumn(name = "productid")
    private ProductEntity product;

    @ManyToOne
    @JoinColumn(name = "cart_id")
    @JsonBackReference
    //@JsonIgnore
    private CartEntity cart;

    private Integer quantity;
    private double discount;
    private double productPrice;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\entity\CustomerEntity.java ================
package com.ecom.cartapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDate;

@Entity
@Getter
@Setter
@Table(name = "customer")
public class CustomerEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long customerId;
    private String name;
    private String email;
    private String password;
    private String pwdUpdated;
    private String phoneNo;
    @CreationTimestamp
    @Column(name="date_created", updatable = false)
    private LocalDate dateCreated;

    @UpdateTimestamp
    @Column(name="last_updated", insertable = false)
    private LocalDate lastUpdated;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\entity\ProductCategory.java ================
package com.ecom.cartapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Entity
@Table(name = "productcategory")
public class ProductCategory
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long categoryId;

    private String categoryName;

    private String active;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\entity\ProductEntity.java ================
package com.ecom.cartapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.time.LocalDate;

@Entity
@Getter
@Setter
@Table(name = "product")
public class ProductEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long productId;
    private String name;
    private String description;
    private String title;
    private Double unitPrice;
    private String imageUrl;
    private boolean active;
    private int unitsInStock;

    @CreationTimestamp
    private LocalDate dateCreated;

    @UpdateTimestamp
    private LocalDate lastUpdated;

    @ManyToOne
    @JoinColumn(name="category_id", nullable = false)
    private ProductCategory category;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\exception\CompileTimeException.java ================
package com.ecom.cartapi.exception;

public class CompileTimeException extends Exception
{
    CompileTimeException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\exception\GenericApiException.java ================
package com.ecom.cartapi.exception;

public class GenericApiException extends RuntimeException
{
    public GenericApiException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\exception\GlobalExceptionHandler.java ================
package com.ecom.cartapi.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler
{
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> myResourceNotFoundException(ResourceNotFoundException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(GenericApiException.class)
    public ResponseEntity<String> myGenericApiException(GenericApiException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(CompileTimeException.class)
    public ResponseEntity<String> myCompileTimeException(CompileTimeException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<String> myValidationError(MethodArgumentNotValidException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> myException(Exception e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\exception\ResourceNotFoundException.java ================
package com.ecom.cartapi.exception;


public class ResourceNotFoundException extends RuntimeException
{
    String resourceName;
    String field;
    String fieldName;
    Integer fieldId;

    public ResourceNotFoundException() {
    }

    public ResourceNotFoundException(String resourceName, String field, String fieldName) {
        super(String.format("%s not found with %s: %s", resourceName, field, fieldName));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldName = fieldName;
    }

    public ResourceNotFoundException(String resourceName, String field, Integer fieldId) {
        super(String.format("%s not found with %s: %d", resourceName, field, fieldId));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldId = fieldId;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\feignclient\Customerapi_feignclient.java ================
package com.ecom.cartapi.feignclient;

import com.ecom.cartapi.dto.AddressDto;
import com.ecom.cartapi.dto.CustomerDto;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;


@FeignClient(name = "CUSTOMERAPI")
public interface Customerapi_feignclient
{
    @GetMapping("/api/customer/get/customer/{customerId}")
    CustomerDto getCustomerDetails(@PathVariable("customerId") Long customerId);

    @GetMapping("/api/address/get/address/{addressId}")
    AddressDto getAddressDetails(@PathVariable("addressId") Long addressId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\feignclient\Productapi_feignclient.java ================
package com.ecom.cartapi.feignclient;

import com.ecom.cartapi.dto.AddressDto;
import com.ecom.cartapi.dto.CustomerDto;
import com.ecom.cartapi.dto.ProductDto;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;

import java.util.List;

@FeignClient(name = "API")
public interface Productapi_feignclient
{
    @GetMapping("/api/products/get/product/{productId}")
    public ProductDto getProductDetails(@PathVariable("productId") Long productId);


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\repository\CartRepository.java ================
package com.ecom.cartapi.repository;

import com.ecom.cartapi.entity.CartEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CartRepository extends JpaRepository<CartEntity , Long>
{
    //CartEntity findByUserUserId(Long customerId);

    CartEntity findByUserCustomerId(Long customerId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\repository\CustomerRepository.java ================
package com.ecom.cartapi.repository;

import com.ecom.cartapi.entity.CustomerEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CustomerRepository extends JpaRepository<CustomerEntity, Long>
{
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\repository\ProductRepository.java ================
package com.ecom.cartapi.repository;


import com.ecom.cartapi.entity.ProductEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ProductRepository extends JpaRepository<ProductEntity, Long> {
    //List<ProductEntity> findByCategoryId();

    //List<ProductEntity> findByProductNameLikeIgnoreCase(String s);

    List<ProductEntity> findByNameLikeIgnoreCase(String s);

    List<ProductEntity> findByCategoryCategoryId(Long categoryId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\service\CartService.java ================
package com.ecom.cartapi.service;

import com.ecom.cartapi.dto.CartDto;

import java.util.List;

public interface CartService {
   public CartDto addProductToCartServ(Long productId, Integer quantity , Long customerId);

    public List<CartDto> getAllCartsServ();

    public CartDto getCustomerCartServ(Long customerId);

    public String deleteCustomerCartserv(Long cartId);


    CartDto deleteProductFromCart(Long cartId, Long productId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\service\CartServiceImpl.java ================
package com.ecom.cartapi.service;

import com.ecom.cartapi.dto.CartDto;
import com.ecom.cartapi.dto.CustomerDto;
import com.ecom.cartapi.dto.ProductDto;
import com.ecom.cartapi.entity.CartEntity;
import com.ecom.cartapi.entity.CartItemEntity;
import com.ecom.cartapi.entity.CustomerEntity;
import com.ecom.cartapi.entity.ProductEntity;
import com.ecom.cartapi.exception.GenericApiException;
import com.ecom.cartapi.exception.ResourceNotFoundException;
import com.ecom.cartapi.feignclient.Customerapi_feignclient;
import com.ecom.cartapi.feignclient.Productapi_feignclient;
import com.ecom.cartapi.repository.CartRepository;
import com.ecom.cartapi.repository.CustomerRepository;
import com.ecom.cartapi.repository.ProductRepository;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class CartServiceImpl implements CartService
{

    @Autowired
    private CartRepository cartrepo;

    @Autowired
    private CustomerRepository customerrepo;

    @Autowired
    private ProductRepository productrepo;

    @Autowired
    private ModelMapper modelmapper;

    @Autowired
    private Customerapi_feignclient customerapiclient;

    @Autowired
    private Productapi_feignclient productapiclient;

    @Override
    public CartDto addProductToCartServ(Long productId, Integer quantity , Long customerId)
    {
        /*
           step-1 = check product exists with productid or not
           step-2 = check if the customer exists with the customerid or not
           step-3 = check if the user asked quantity is lessthan the existing quantity
           step-4 = check if the product is already present in the cart if already present in  the cart then update the cart +1
           step-5 =
         */



        /*CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));
         */

        // interservice communication
        CustomerDto customerdto = customerapiclient.getCustomerDetails(customerId);
        CustomerEntity customerentity = modelmapper.map(customerdto , CustomerEntity.class);


       /* ProductEntity productentity = productrepo.findById(productId)
                .orElseThrow(()->new ResourceNotFoundException("product","productId",""+productId));
        */

        // interservice communication
        ProductDto productdto = productapiclient.getProductDetails(productId);
        ProductEntity productentity = modelmapper.map(productdto , ProductEntity.class);




        /*

          CartEntity cart = createCart(customerentity);
        List<CartItemEntity> allcartitems = cart.getCartitem();
         allcartitems.stream()
                 .filter(individualcartitem-> individualcartitem.getProduct().getProductId()==productId)
                 .map(individualcartitem->{
                     individualcartitem.setQuantity(individualcartitem.getQuantity()+1);
                     individualcartitem.setProductPrice(individualcartitem.getProductPrice()+productentity.getUnitPrice());
                 });

         */
        CartEntity cart = createCart(customerentity);

        Optional<CartItemEntity> existingItem = cart.getCartitem().stream()
                .filter(item -> item.getProduct().getProductId().equals(productId))
                .findFirst();   // stream TERMINATES here

        // question = how the changing the value in the exitstingItem is reflecting in the customerentity

        if (existingItem.isPresent())
        {
            CartItemEntity item = existingItem.get();
            item.setQuantity(item.getQuantity() + 1);
            item.setProductPrice(item.getQuantity() * productentity.getUnitPrice());
            CartEntity savedcart =cartrepo.save(cart);
            return modelmapper.map(savedcart , CartDto.class);
        }

        CartItemEntity newcartitem = new CartItemEntity();
        newcartitem.setQuantity(quantity);
        newcartitem.setProduct(productentity);
        newcartitem.setCart(cart);
        newcartitem.setProductPrice(quantity*productentity.getUnitPrice());
        newcartitem.setDiscount(10);

        //doubt
        cart.setCartitems(newcartitem);
        cart.setTotalPrice(cart.getTotalPrice()+ newcartitem.getProductPrice());
        CartEntity savedcart = cartrepo.save(cart);

        return modelmapper.map(savedcart , CartDto.class);
    }

    private CartEntity createCart(CustomerEntity customerentity)
    {
        /*
           question = how jpa takes the customerId form the customerentity if we use the findByUser(customerentity) in the
                      customerrepo
         */
        CartEntity cart = cartrepo.findByUserCustomerId(customerentity.getCustomerId());

        if(cart !=null)
        {
            return cart;
        }

        CartEntity newcart = new CartEntity();
        newcart.setUser(customerentity);
        newcart.setTotalPrice(0.0);
        cartrepo.save(newcart);

        return newcart;
    }

    @Override
    public List<CartDto> getAllCartsServ()
    {
        List<CartEntity> allcartentities = cartrepo.findAll();
        List<CartDto> allcartdtos = allcartentities.stream()
                .map(individualcartentity -> modelmapper.map(individualcartentity , CartDto.class))
                .toList();

        return allcartdtos;
    }

    @Override
    public CartDto getCustomerCartServ(Long customerId)
    {
        /*
        CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));
         */

        // interservice communication
        CustomerDto customerdto = customerapiclient.getCustomerDetails(customerId);
        CustomerEntity customerentity = modelmapper.map(customerdto , CustomerEntity.class);


        //doubt = why cant we use orelsethrow here
        CartEntity cartentity = cartrepo.findByUserCustomerId(customerId);
        if(cartentity==null)
        {
            throw new GenericApiException("there is no cart for the user with customerId "+customerId);
        }
        return modelmapper.map(cartentity , CartDto.class);
    }

    @Override
    public String deleteCustomerCartserv(Long cartId)
    {
        //doubt = why cant we use orelsethrow here
        CartEntity cartentity = cartrepo.findById(cartId)
                .orElseThrow(()->new GenericApiException("there is no cart for the user with customerId "+cartId));

        cartrepo.deleteById(cartId);
        return "success";
    }

    @Override
    public CartDto deleteProductFromCart(Long cartId, Long productId)
    {
        CartEntity cartentity = cartrepo.findById(cartId)
                .orElseThrow(()->new GenericApiException("there is no cart for the user with customerId "+cartId));


        /*ProductEntity productentity = productrepo.findById(productId)
                .orElseThrow(()->new ResourceNotFoundException("product","productId",""+productId));
         */

        // interservice communication
        ProductDto productdto = productapiclient.getProductDetails(productId);
        ProductEntity productentity = modelmapper.map(productdto , ProductEntity.class);

        // check if the product is present in the cart or not
        List<CartItemEntity> allcartitementities = cartentity.getCartitem();
        CartItemEntity carttiem = allcartitementities.stream()
                .filter(individualcartitem->individualcartitem.getProduct().getProductId().equals(productId))
                .findFirst()
                .orElseThrow(()->new GenericApiException("there is no product with the productId "+productId+" inside the cart with the cartId "+cartId));

        //cartentity.getCartitem().remove(carttiem);
        allcartitementities.remove(carttiem);

        cartentity.setCartitem(null);
        cartentity.setCartitem(allcartitementities);
        CartEntity savedcartentity = cartrepo.save(cartentity);

        return modelmapper.map(savedcartentity , CartDto.class);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\springsecurity\config\SecurityConfig.java ================
package com.ecom.cartapi.springsecurity.config;


import com.ecom.cartapi.springsecurity.filter.GatewayAuthenticationFilter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Slf4j
@EnableMethodSecurity(prePostEnabled = true)
@Configuration
public class SecurityConfig
{
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, GatewayAuthenticationFilter gatewayAuthenticationFilter) throws Exception
    {
        log.info("NATALIE control entered securityFilterChain ");
            http.csrf(csrf -> csrf.disable())
                .sessionManagement(sm ->
                                           sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS) )
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(gatewayAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

            return http.build();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\springsecurity\filter\GatewayAuthenticationFilter.java ================
package com.ecom.cartapi.springsecurity.filter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Component
public class GatewayAuthenticationFilter extends OncePerRequestFilter
{
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException
    {
        log.info("NATALIE control entered doFilterInternal");

        String userId = request.getHeader("X-User-Id");
        log.info("NATALIE control entered doFilterInternal");

        String authoritiesHeader = request.getHeader("X-User-Authorities");
        log.info("NATALIE control entered doFilterInternal");

        if (userId != null && authoritiesHeader != null)
        {
            /*
            List<SimpleGrantedAuthority> authorities =
                    Arrays.stream(authoritiesHeader.split(","))
                            .map(String::trim)
                            .map(SimpleGrantedAuthority::new)
                            .toList();
             */
            List<SimpleGrantedAuthority> authorities = new ArrayList<>();

            String[] authorityArray = authoritiesHeader.split(",");

            for (String authority : authorityArray) {
                String cleaned = authority.trim();
                SimpleGrantedAuthority grantedAuthority =
                        new SimpleGrantedAuthority(cleaned);

                authorities.add(grantedAuthority);
            }


            log.info("NATALIE List<SimpleGrantedAuthority> authorities = "+authorities);

            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userId, null, authorities);
            log.info("NATALIE authentication object created is = "+authentication);

            SecurityContextHolder.getContext().setAuthentication(authentication);
            log.info("NATALIE execution of doFilterInternal is completed and authentiction object in the securitycontextholder is ="+SecurityContextHolder.getContext().getAuthentication());

        }
        filterChain.doFilter(request, response);

    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\java\com\ecom\cartapi\springsecurity\interceptor\FeinClientInterceptor.java ================
package com.ecom.cartapi.springsecurity.interceptor;

import feign.RequestInterceptor;
import feign.RequestTemplate;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import java.util.Set;
import java.util.stream.Collectors;

@Slf4j
@Component
public class FeinClientInterceptor implements RequestInterceptor
{
    @Override
    public void apply(RequestTemplate requestTemplate)
    {
        log.info("NATALIE control entered the FeinClientInterceptor");
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        log.info("NATALIE authentication object is = "+authentication);


        if(authentication != null)
        {
            Long userId = (Long)authentication.getPrincipal();

            requestTemplate.header("X-User-Id", userId.toString());
            log.info("NATALIE userId = "+userId);

            //Collection<? extends GrantedAuthority> authorities = authentication.getAuthorities();

            //  Converting authorities to Set<String>
            Set<String> authoritiesOfUser = authentication.getAuthorities().stream()
                                                                .map(GrantedAuthority::getAuthority)
                                                                .collect(Collectors.toSet());
            log.info("NATALIE converting Collection<? extends GrantedAuthority> authorities to Set<String> = "+authoritiesOfUser);

            //  Joining authorities using comma
            String authoritiesHeader = String.join(",", authoritiesOfUser);
            log.info("NATALIE converting Set<String> to string "+authoritiesHeader);

            // Adding header
            requestTemplate.header("X-User-Authorities", authoritiesHeader);


        }
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\main\resources\application.properties ================
spring.application.name=cartapi


#spring.datasource.url=jdbc:mysql://host.docker.internal:3306/latest_microservices_ecommerce_db
#spring.datasource.username=root
#spring.datasource.password=Nvr144@144
#spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# ===============================
# DATABASE (PostgreSQL - Docker)
# ===============================
spring.datasource.url=jdbc:postgresql://microservice-db:5432/microservicedb
spring.datasource.username=user
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

server.port=7004

eureka.instance.prefer-ip-address=true

eureka.client.service-url.defaultZone=http://eurekaserver:8761/eureka


================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\cartapi\src\test\java\com\ecom\cartapi\CartapiApplicationTests.java ================
package com.ecom.cartapi;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class CartapiApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 7003

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecom</groupId>
	<artifactId>customerapi</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>customerapi</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>

		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-actuator</artifactId>
		</dependency>

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.2.2</version>
		</dependency>

		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.13</version>
		</dependency>

		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>


		<!-- JWT -->
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.12.6</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.12.6</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.12.6</version>
			<scope>runtime</scope>
		</dependency>


		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>

	</dependencies>


	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\CustomerapiApplication.java ================
package com.ecom.customerapi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class CustomerapiApplication {

	public static void main(String[] args) {
		SpringApplication.run(CustomerapiApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\config\MapperConfig.java ================
package com.ecom.customerapi.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MapperConfig
{
    @Bean
    public ModelMapper getmapper()
    {
        return new ModelMapper();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\controller\AddressController.java ================
package com.ecom.customerapi.controller;

import com.ecom.customerapi.dto.AddressDto;
import com.ecom.customerapi.dto.CustomerDto;
import com.ecom.customerapi.service.AddressService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api")
public class AddressController
{
    @Autowired
    private AddressService addressservice;

    @PostMapping("/add/address/{customerId}")
    public ResponseEntity<AddressDto> addNewCustomerAddress(@PathVariable Long customerId,@RequestBody AddressDto addressdto)
    {
        AddressDto addresssaved = addressservice.addNewAddress(addressdto , customerId);
        return new ResponseEntity<>(addresssaved , HttpStatus.CREATED);
    }

    @GetMapping("/getall/addresses")
    public ResponseEntity<List<AddressDto>> getAllAddress()
    {
        List<AddressDto> allAddresses = addressservice.getAllAddresses();
        return new ResponseEntity<>(allAddresses , HttpStatus.CREATED);
    }

    @GetMapping("/getall/addresses/{customerId}")
    public ResponseEntity<List<AddressDto>> getAllAddressofCustomerById(@PathVariable Long customerId)
    {
        List<AddressDto> allAddressesofcustomer = addressservice.getAllAddressofCustomerByIdServ(customerId);
        return new ResponseEntity<>(allAddressesofcustomer , HttpStatus.CREATED);
    }

    @DeleteMapping("/delete/address/{addressId}")
    public ResponseEntity<String> deleteCustomerAddress(@PathVariable Long addressId)
    {
        String message = addressservice.deleteCustomerAddressServ(addressId);
        return new ResponseEntity<>(message , HttpStatus.CREATED);
    }

    @PutMapping("/update/address/{addressId}")
    public ResponseEntity<AddressDto> updateCustomerAddress(@PathVariable Long addressId,@RequestBody AddressDto addressdto)
    {
        AddressDto updatedAddress = addressservice.updateAddress(addressdto , addressId);
        return new ResponseEntity<>(updatedAddress , HttpStatus.CREATED);
    }



}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\controller\CustomerController.java ================
package com.ecom.customerapi.controller;


import com.ecom.customerapi.dto.CustomerDto;
import com.ecom.customerapi.repository.CustomerRepository;
import com.ecom.customerapi.service.CustomerService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/customer")
public class CustomerController
{

    @Autowired
    private CustomerService customerservice;

    @Autowired
    private CustomerRepository customerrepo;

    /**
     * Create a new customer
     */
    @PostMapping("/add/customer")
    //@PreAuthorize("hasAnyRole('SELLER','ADMIN','USER') and hasAuthority('USER_CREATE')")
    public ResponseEntity<CustomerDto> addNewCustomer(@RequestBody CustomerDto customerdto)
    {
        log.info("NATALIE control entered the addnewcustomer with the customerdto "+customerdto);
        System.out.println("========================================================================================================================================================================");
        CustomerDto customersaved = customerservice.addNewCustomerserv(customerdto);

        return new ResponseEntity<>(customersaved, HttpStatus.CREATED);
    }

    /**
     * Get all customers (ADMIN only)
     */
    @GetMapping("/getall/customers")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('USER_VIEW_ALL')")
    public ResponseEntity<List<CustomerDto>> getallCustomers()
    {

        List<CustomerDto> allcustomers = customerservice.getAllCustomers();

        return new ResponseEntity<>(allcustomers, HttpStatus.CREATED);
    }

    /**
     * Get logged-in customer details
     */
    @GetMapping("/get/logged/customerdetails")
    @PreAuthorize("hasAnyRole('ADMIN','USER') and hasAuthority('USER_VIEW')")
    public ResponseEntity<CustomerDto> getCustomerDetails()
    {

        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

        String userId = (String) authentication.getPrincipal();
        Long customerId = Long.valueOf(userId);

        CustomerDto onecustomer = customerservice.getCustomerByIdserv(customerId);

        return new ResponseEntity<>(onecustomer, HttpStatus.CREATED);
    }

    /**
     * Update customer (ADMIN only)
     */
    @PutMapping("/get/category/{customerId}")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('USER_UPDATE')")
    public ResponseEntity<CustomerDto> updateCustomer(@PathVariable Long customerId, @RequestBody CustomerDto customerdto) {
        CustomerDto onecustomer =
                customerservice.updateCustomerServ(customerId, customerdto);

        return new ResponseEntity<>(onecustomer, HttpStatus.CREATED);
    }

    /**
     * Delete customer (ADMIN only)
     */
    @DeleteMapping("/delete/category/{customerId}")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('USER_DELETE')")
    public ResponseEntity<String> deleteCustomer(@PathVariable Long customerId)
    {
        String message =
                customerservice.deleteCustomerServ(customerId);

        return new ResponseEntity<>(message, HttpStatus.CREATED);
    }

    /**
     * Get customer by ID (ADMIN only)
     */
    @GetMapping("/get/customer/{customerId}")
    @PreAuthorize("hasAnyRole('ADMIN') and hasAuthority('USER_VIEW')")
    public ResponseEntity<CustomerDto> getCustomerDetailsByIdByAdmin(@PathVariable Long customerId)
    {
        CustomerDto onecustomer = customerservice.getCustomerByIdserv(customerId);

        return new ResponseEntity<>(onecustomer, HttpStatus.CREATED);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\dto\AddressDto.java ================
package com.ecom.customerapi.dto;

import com.ecom.customerapi.entity.CustomerEntity;
import lombok.Data;

@Data
public class AddressDto
{
    private Long addrId;
    private String hno;
    private String street;
    private String city;
    private String state;
    private String zipCode;
    private String addrType;
    private String deleteSw;

    //private CustomerEntity customer;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\dto\CustomerDto.java ================
package com.ecom.customerapi.dto;

import com.ecom.customerapi.enums.Role;
import jakarta.persistence.Column;
import lombok.Data;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDate;
import java.util.Set;

@Data
public class CustomerDto
{
    private Long customerId;
    private String name;
    private String email;
    private String phoneNo;

    private Set<Role> roles;

    private LocalDate dateCreated;
    private LocalDate lastUpdated;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\entity\AddressEntity.java ================
package com.ecom.customerapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
@Table(name = "customer_address")
public class AddressEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long addrId;
    private String hno;
    private String street;
    private String city;
    private String state;
    private String zipCode;
    private String addrType;
    private String deleteSw;

    @ManyToOne
    @JoinColumn(name = "customer_id")
    private CustomerEntity customer;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\entity\CustomerEntity.java ================
package com.ecom.customerapi.entity;



import com.ecom.customerapi.enums.Role;

import com.ecom.customerapi.springsecurity.config.PermissionMapping;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDate;
import java.util.HashSet;
import java.util.Set;

@Entity
@Getter
@Setter
@ToString
@Table(name = "customer")
public class CustomerEntity {

    @Id
    private Long customerId;

    private String name;
    private String email;
    private String phoneNo;

    @ElementCollection(fetch = FetchType.EAGER)
    @Enumerated(EnumType.STRING)
    private Set<Role> roles;

    @CreationTimestamp
    @Column(name = "date_created", updatable = false)
    private LocalDate dateCreated;

    @UpdateTimestamp
    @Column(name = "last_updated", insertable = false)
    private LocalDate lastUpdated;

    public Set<String> getAuthorities() {
        Set<String> authorities = new HashSet<>();

        for (Role role : roles) {
            authorities.add("ROLE_" + role.name());
            authorities.addAll(PermissionMapping.getAuthoritiesForRole(role));
        }
        return authorities;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\enums\Permission.java ================
package com.ecom.customerapi.enums;

public enum Permission
{
    /* ================= USER ================= */
    USER_VIEW, USER_CREATE, USER_UPDATE, USER_DELETE, USER_VIEW_ALL,

    /* ================= ADDRESS ================= */
    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,

    /* ================= PRODUCT ================= */
    PRODUCT_VIEW, PRODUCT_CREATE,PRODUCT_UPDATE, PRODUCT_DELETE,

    /* ================= CATEGORY ================= */
    CATEGORY_VIEW, CATEGORY_CREATE, CATEGORY_UPDATE, CATEGORY_DELETE,

    /* ================= ORDER ================= */
    ORDER_VIEW, ORDER_CREATE, ORDER_UPDATE, ORDER_CANCEL, ORDER_VIEW_ALL,

    /* ================= CART ================= */
    CART_VIEW, CART_ADD_ITEM, CART_REMOVE_ITEM, CART_CLEAR, CART_VIEW_ALL,

    /* ================= PAYMENT ================= */
    PAYMENT_INITIATE, PAYMENT_VIEW,

    /* ================= INVENTORY ================= */
    INVENTORY_VIEW, INVENTORY_UPDATE
}


================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\enums\Role.java ================
package com.ecom.customerapi.enums;

public enum Role
{
    USER,
    SELLER,
    ADMIN,
    NORMAL
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\exception\CompileTimeException.java ================
package com.ecom.customerapi.exception;

public class CompileTimeException extends Exception
{
    CompileTimeException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\exception\GenericApiException.java ================
package com.ecom.customerapi.exception;

public class GenericApiException extends RuntimeException
{
    GenericApiException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\exception\GlobalExceptionHandler.java ================
package com.ecom.customerapi.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler
{
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> myResourceNotFoundException(ResourceNotFoundException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(GenericApiException.class)
    public ResponseEntity<String> myGenericApiException(GenericApiException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(CompileTimeException.class)
    public ResponseEntity<String> myCompileTimeException(CompileTimeException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<String> myValidationError(MethodArgumentNotValidException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> myException(Exception e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\exception\ResourceNotFoundException.java ================
package com.ecom.customerapi.exception;


public class ResourceNotFoundException extends RuntimeException
{
    String resourceName;
    String field;
    String fieldName;
    Integer fieldId;

    public ResourceNotFoundException() {
    }

    public ResourceNotFoundException(String resourceName, String field, String fieldName) {
        super(String.format("%s not found with %s: %s", resourceName, field, fieldName));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldName = fieldName;
    }

    public ResourceNotFoundException(String resourceName, String field, Integer fieldId) {
        super(String.format("%s not found with %s: %d", resourceName, field, fieldId));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldId = fieldId;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\repository\AddressRepository.java ================
package com.ecom.customerapi.repository;

import com.ecom.customerapi.entity.AddressEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface AddressRepository extends JpaRepository<AddressEntity , Long>
{
    List<AddressEntity> findByCustomer_CustomerId(Long customerId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\repository\CustomerRepository.java ================
package com.ecom.customerapi.repository;

import com.ecom.customerapi.entity.CustomerEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CustomerRepository extends JpaRepository<CustomerEntity , Long>
{
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\service\AddressService.java ================
package com.ecom.customerapi.service;

import com.ecom.customerapi.dto.AddressDto;

import java.util.List;

public interface AddressService
{
    public AddressDto addNewAddress(AddressDto addressdto, Long customerId);

    public List<AddressDto> getAllAddresses();

    public List<AddressDto> getAllAddressofCustomerByIdServ(Long customerId);

    public String deleteCustomerAddressServ(Long addressId);

    AddressDto updateAddress(AddressDto addressdto, Long addressId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\service\AddressServiceImpl.java ================
package com.ecom.customerapi.service;

import com.ecom.customerapi.dto.AddressDto;
import com.ecom.customerapi.entity.AddressEntity;
import com.ecom.customerapi.entity.CustomerEntity;
import com.ecom.customerapi.exception.ResourceNotFoundException;
import com.ecom.customerapi.repository.AddressRepository;
import com.ecom.customerapi.repository.CustomerRepository;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class AddressServiceImpl implements AddressService
{
    @Autowired
    private CustomerRepository customerrepo;

    @Autowired
    private ModelMapper modelmapper;

    @Autowired
    private AddressRepository addressrepo;

    @Override
    public AddressDto addNewAddress(AddressDto addressdto, Long customerId)
    {
        CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));

        AddressEntity addressentity = modelmapper.map(addressdto , AddressEntity.class);
        addressentity.setCustomer(customerentity);

        AddressEntity savedaddress = addressrepo.save(addressentity);
        return modelmapper.map(savedaddress , AddressDto.class);
    }

    @Override
    public List<AddressDto> getAllAddresses()
    {
        List<AddressEntity> alladdressentity = addressrepo.findAll();
        List<AddressDto> alladdressdtos = alladdressentity.stream()
                .map(individualaddressentity -> modelmapper.map(individualaddressentity , AddressDto.class))
                .toList();

        return alladdressdtos;
    }

    @Override
    public List<AddressDto> getAllAddressofCustomerByIdServ(Long customerId)
    {
        CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));

        List<AddressEntity> alladdressentityofCustomer = addressrepo.findByCustomer_CustomerId(customerId);
        List<AddressDto> alladdressdtosofCustomer = alladdressentityofCustomer.stream()
                .map(individualaddressentity -> modelmapper.map(individualaddressentity , AddressDto.class))
                .toList();

        return alladdressdtosofCustomer;
    }

    @Override
    public String deleteCustomerAddressServ(Long addressId)
    {
        AddressEntity addressentity = addressrepo.findById(addressId)
                .orElseThrow(()-> new ResourceNotFoundException("address","addressId",""+addressId));

        addressrepo.deleteById(addressId);
        return "success";
    }

    @Override
    public AddressDto updateAddress(AddressDto addressdto, Long addressId)
    {
        AddressEntity addressentity = addressrepo.findById(addressId)
                .orElseThrow(()-> new ResourceNotFoundException("address","addressId",""+addressId));

        addressentity.setHno(addressdto.getHno());
        addressentity.setCity(addressdto.getCity());
        addressentity.setState(addressdto.getState());
        addressentity.setStreet(addressdto.getStreet());
        addressentity.setAddrType(addressdto.getAddrType());
        addressentity.setDeleteSw(addressdto.getDeleteSw());
        addressentity.setZipCode(addressdto.getZipCode());

        AddressEntity savedaddress = addressrepo.save(addressentity);

        return modelmapper.map(savedaddress , AddressDto.class);
    }


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\service\CustomerService.java ================
package com.ecom.customerapi.service;

import com.ecom.customerapi.dto.CustomerDto;

import java.util.List;

public interface CustomerService {
    CustomerDto addNewCustomerserv(CustomerDto customerdto);

    List<CustomerDto> getAllCustomers();

    CustomerDto getCustomerByIdserv(Long customerId);

    CustomerDto updateCustomerServ(Long customerId ,CustomerDto customerdto);

    String deleteCustomerServ(Long customerId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\service\CustomerServiceImpl.java ================
package com.ecom.customerapi.service;

import com.ecom.customerapi.dto.CustomerDto;
import com.ecom.customerapi.entity.CustomerEntity;
import com.ecom.customerapi.exception.ResourceNotFoundException;
import com.ecom.customerapi.repository.CustomerRepository;
import lombok.extern.slf4j.Slf4j;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Slf4j
@Service
public class CustomerServiceImpl implements CustomerService
{

    @Autowired
    private ModelMapper modelmapper;

    @Autowired
    private CustomerRepository customerrepo;

    @Override
    public CustomerDto addNewCustomerserv(CustomerDto customerdto)
    {
        log.info("NATALIE control entered addNewCustomerserv");
        /*
            1.check if the customer is present previously or not using customer name
            2.if not there create a new account
         */

        CustomerEntity customerentity = modelmapper.map(customerdto , CustomerEntity.class);
        log.info("converting the customerdto to the customerentity = "+customerentity);

        CustomerEntity savedcustomer = customerrepo.save(customerentity);
        log.info("saved customerentity is ="+savedcustomer);

        return modelmapper.map(savedcustomer , CustomerDto.class);
    }

    @Override
    public List<CustomerDto> getAllCustomers()
    {
        List<CustomerEntity> allcutomerentities = customerrepo.findAll();

        List<CustomerDto> allcutomerdtos = allcutomerentities.stream()
                .map(individualcustomerentiy -> modelmapper.map(individualcustomerentiy , CustomerDto.class))
                .toList();

        return allcutomerdtos;
    }

    @Override
    public CustomerDto getCustomerByIdserv(Long customerId)
    {
        /*
            1.check if the customer is present with the id or not
         */

        CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));

        return modelmapper.map(customerentity , CustomerDto.class);
    }

    @Override
    public CustomerDto updateCustomerServ(Long customerId,CustomerDto customerdto)
    {
        CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerdto.getCustomerId()));

        customerentity.setName(customerdto.getName());
        customerentity.setEmail(customerdto.getEmail());
        customerentity.setPhoneNo(customerdto.getPhoneNo());
        customerentity.setLastUpdated(customerdto.getLastUpdated());


        CustomerEntity updatedcustomer = customerrepo.save(customerentity);

        return modelmapper.map(updatedcustomer , CustomerDto.class);
    }

    @Override
    public String deleteCustomerServ(Long customerId)
    {
        CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));

        customerrepo.deleteById(customerId);
        return "success";
    }


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\springsecurity\config\PermissionMapping.java ================
package com.ecom.customerapi.springsecurity.config;



import com.ecom.customerapi.enums.Permission;
import com.ecom.customerapi.enums.Role;
import lombok.extern.slf4j.Slf4j;


import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import static com.ecom.customerapi.enums.Permission.*;
import static com.ecom.customerapi.enums.Role.*;


@Slf4j
public class PermissionMapping
{
    /*private static final Map<Role, Set<Permission>> map = Map.of(
            USER, Set.of(USER_VIEW, POST_VIEW),
            SELLER, Set.of(POST_CREATE, USER_UPDATE, POST_UPDATE),
            ADMIN, Set.of(POST_CREATE, USER_UPDATE, POST_UPDATE, USER_DELETE, USER_CREATE, POST_DELETE)
    );*/

    private static final Map<Role, Set<Permission>> map = Map.of(

            /* ================= CUSTOMER ================= */
            USER, Set.of(
                    USER_VIEW, USER_UPDATE,
                    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,
                    PRODUCT_VIEW, CATEGORY_VIEW,
                    CART_VIEW, CART_ADD_ITEM, CART_REMOVE_ITEM, CART_CLEAR,
                    ORDER_CREATE, ORDER_VIEW, ORDER_CANCEL,
                    PAYMENT_INITIATE, PAYMENT_VIEW
            ),

            /* ================= SELLER ================= */
            SELLER, Set.of(
                    USER_VIEW, USER_UPDATE,
                    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,
                    PRODUCT_VIEW, PRODUCT_CREATE, PRODUCT_UPDATE,
                    CATEGORY_VIEW,
                    INVENTORY_VIEW, INVENTORY_UPDATE,
                    ORDER_VIEW
            ),

            /* ================= ADMIN ================= */
            ADMIN, Set.of(
                    USER_VIEW, USER_VIEW_ALL, USER_CREATE, USER_UPDATE, USER_DELETE,
                    ADDRESS_VIEW, ADDRESS_CREATE, ADDRESS_UPDATE, ADDRESS_DELETE,
                    PRODUCT_VIEW, PRODUCT_CREATE, PRODUCT_UPDATE, PRODUCT_DELETE,
                    CATEGORY_VIEW, CATEGORY_CREATE, CATEGORY_UPDATE, CATEGORY_DELETE,
                    CART_VIEW, CART_VIEW_ALL, ORDER_VIEW,
                    ORDER_UPDATE, ORDER_VIEW_ALL, ORDER_CANCEL,
                    INVENTORY_VIEW, INVENTORY_UPDATE,
                    PAYMENT_VIEW

            )
    );

    public static Set<String> getAuthoritiesForRole(Role role)
    {
        log.info("PermissionMapping â†’ resolving permissions for role {}", role);

         Set<String> authorities  =  map.getOrDefault(role, Set.of())
                                        .stream()
                                        .map(Permission::name)
                                        .collect(Collectors.toSet());
        return authorities;
    }

  /*  public static Set<String> getAuthoritiesForRole(Role role)
    {

        Set<String> allpermissions = map.get(role).stream()
                .map(permission -> permission))
                .collect(Collectors.toSet());

        return allpermissions;
    }

    public static Set<String> getAuthoritiesForRole(Role roles)
    {


        Set<String> authorities = new HashSet<>();

        for (Role role : roles) {
            // ROLE authority
            authorities.add("ROLE_" + role.name());

            // Permission authorities
            ROLE_PERMISSION_MAP
                    .getOrDefault(role, Set.of())
                    .forEach(p -> authorities.add(p.name()));
        }

        return authorities;
    }
*/

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\springsecurity\config\SecurityConfig.java ================
package com.ecom.customerapi.springsecurity.config;



import com.ecom.customerapi.springsecurity.filter.GatewayAuthenticationFilter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Slf4j
@EnableMethodSecurity(prePostEnabled = true)
@Configuration
public class SecurityConfig
{
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, GatewayAuthenticationFilter gatewayAuthenticationFilter) throws Exception
    {
        log.info("NATALIE control entered securityFilterChain ");
            http.csrf(csrf -> csrf.disable())
                .sessionManagement(sm ->
                                           sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS) )
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(gatewayAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

            return http.build();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\java\com\ecom\customerapi\springsecurity\filter\GatewayAuthenticationFilter.java ================
package com.ecom.customerapi.springsecurity.filter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Component
public class GatewayAuthenticationFilter extends OncePerRequestFilter
{
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException
    {
        log.info("NATALIE control entered doFilterInternal");

        String userId = request.getHeader("X-User-Id");
        log.info("NATALIE control entered doFilterInternal");

        String authoritiesHeader = request.getHeader("X-User-Authorities");
        log.info("NATALIE control entered doFilterInternal");

        if (userId != null && authoritiesHeader != null)
        {
            /*
            List<SimpleGrantedAuthority> authorities =
                    Arrays.stream(authoritiesHeader.split(","))
                            .map(String::trim)
                            .map(SimpleGrantedAuthority::new)
                            .toList();
             */
            List<SimpleGrantedAuthority> authorities = new ArrayList<>();

            String[] authorityArray = authoritiesHeader.split(",");

            for (String authority : authorityArray) {
                String cleaned = authority.trim();
                SimpleGrantedAuthority grantedAuthority =
                        new SimpleGrantedAuthority(cleaned);

                authorities.add(grantedAuthority);
            }


            log.info("NATALIE List<SimpleGrantedAuthority> authorities = "+authorities);

            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userId, null, authorities);
            log.info("NATALIE authentication object created is = "+authentication);

            SecurityContextHolder.getContext().setAuthentication(authentication);
            log.info("NATALIE execution of doFilterInternal is completed and authentiction object in the securitycontextholder is ="+SecurityContextHolder.getContext().getAuthentication());

        }
        filterChain.doFilter(request, response);

    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\main\resources\application.properties ================
spring.application.name=customerapi


#spring.datasource.url=jdbc:mysql://host.docker.internal:3306/timesecurity
#spring.datasource.username=root
#spring.datasource.password=Nvr144@144
#spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# ===============================
# DATABASE (PostgreSQL - Docker)
# ===============================
spring.datasource.url=jdbc:postgresql://microservice-db:5432/microservicedb
spring.datasource.username=user
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

server.port=7003

eureka.client.service-url.defaultZone=http://eurekaserver:8761/eureka

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\customerapi\src\test\java\com\ecom\customerapi\CustomerapiApplicationTests.java ================
package com.ecom.customerapi;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class CustomerapiApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\eurekaserver\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 8761

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\eurekaserver\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecom</groupId>
	<artifactId>eurekaserver</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>eurekaserver</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\eurekaserver\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\eurekaserver\src\main\java\com\ecom\eurekaserver\EurekaserverApplication.java ================
package com.ecom.eurekaserver;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaserverApplication {

	public static void main(String[] args) {
		SpringApplication.run(EurekaserverApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\eurekaserver\src\main\resources\application.yml ================
spring:
  application:
    name: eurekaserver
server:
  port: 8761

eureka:
  client:
    register-with-eureka: false
    fetch-registry: false

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\eurekaserver\src\test\java\com\ecom\eurekaserver\EurekaserverApplicationTests.java ================
package com.ecom.eurekaserver;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class EurekaserverApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 7005

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.ecom</groupId>
	<artifactId>orderapi</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>orderapi</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>

		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>



		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-actuator</artifactId>
		</dependency>

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.2.2</version>
		</dependency>

		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.13</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>





		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-brave</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin</artifactId>
		</dependency>
		<dependency>
			<groupId>io.micrometer</groupId>
			<artifactId>micrometer-tracing-bridge-brave</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin-test</artifactId>
			<scope>test</scope>
		</dependency>



		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>

	</dependencies>


	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>


	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\OrderapiApplication.java ================
package com.ecom.orderapi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
public class OrderapiApplication {

	public static void main(String[] args)
	{
		SpringApplication.run(OrderapiApplication.class, args);
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\config\MapperConfig.java ================
package com.ecom.orderapi.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MapperConfig
{
    @Bean
    public ModelMapper getMapper()
    {
        return new ModelMapper();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\controller\OrderController.java ================
package com.ecom.orderapi.controller;

import com.ecom.orderapi.dto.*;
import com.ecom.orderapi.repository.OrderRepository;
import com.ecom.orderapi.service.OrderService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/orders")
public class OrderController
{
    @Autowired
    private OrderService orderservice;

    @Autowired
    private OrderRepository orderrepo;

//    @PostMapping("/createorder")
//    public ResponseEntity<PurchaseOrderResponseDto> createOrder(@RequestBody PurchaseOrderRequestDto purchaseorder)
//    {
//        PurchaseOrderResponseDto purchaseresponse = orderservice.createOrderServ(purchaseorder);
//        return new ResponseEntity<>(purchaseresponse , HttpStatus.CREATED);
//    }

    @GetMapping("/getall/orders")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('ORDER_VIEW_ALL')")
    public  ResponseEntity<List<OrderResponseDto>> getAllOrders()
    {
        List<OrderResponseDto> allorderdtos = orderservice.getAllOrdersServ();
        return new ResponseEntity<>(allorderdtos , HttpStatus.OK);
    }

    @GetMapping("/getall/orders/{customerId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('ORDER_VIEW')")
    public  ResponseEntity<List<OrderResponseDto>> getAllOrdersofCustomer(@PathVariable Long customerId)
    {
        List<OrderResponseDto> allorderdtos = orderservice.getAllOrdersOfCustomerServ(customerId);
        return new ResponseEntity<>(allorderdtos, HttpStatus.OK);
    }

    @GetMapping("/get/order/byorderid/{orderId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('ORDER_VIEW')")
    public  ResponseEntity<OrderResponseDto> getOrderByOrderId(@PathVariable Long orderId)
    {
        OrderResponseDto orderdto = orderservice.getOrderByOrderIdServ(orderId);
        return new ResponseEntity<>(orderdto , HttpStatus.OK);
    }

    @PutMapping("/modify/order/{orderId}")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('ORDER_UPDATE')")
    public  ResponseEntity<OrderDto> modifyOrder(@PathVariable Long orderId,@RequestBody OrderDto orderdto)
    {
        OrderDto modifiedorderdto = orderservice.modifyOrderServ(orderdto);

        return new ResponseEntity<>(modifiedorderdto ,HttpStatus.OK);
    }

    @DeleteMapping("/cancel/order/byorderid/{orderId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('ORDER_CANCEL')")
    public  ResponseEntity<PurchaseOrderResponseDto> cancelOrder(@PathVariable Long orderId)
    {
        System.out.println("entered the cancel controller for orderId = "+orderId);
        PurchaseOrderResponseDto purchaseresponse = orderservice.cancelOrderServ(orderId);
        return new ResponseEntity<>(purchaseresponse , HttpStatus.ACCEPTED);
    }

    @PostMapping("/placeorder")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('ORDER_CREATE')")
    public ResponseEntity<PurchaseOrderResponseDto> placeOrder(@RequestBody PlaceOrderDto placeorderdto)
    {
        PurchaseOrderResponseDto purchaseresponse = orderservice.placeOrderServ(placeorderdto);
       return new ResponseEntity<>(purchaseresponse , HttpStatus.CREATED);
        //return new ResponseEntity<>(new PurchaseOrderResponseDto() , HttpStatus.CREATED);
    }

    @GetMapping("/get/customerdetails/from/orderapi")
    @PreAuthorize("hasAnyRole('USER','ADMIN','SELLER') and hasAuthority('USER_VIEW')")
    public ResponseEntity<CustomerDto> getUserDetails()
    {
        CustomerDto customerdto = orderservice.getCustomerDetails();
        return new ResponseEntity<>(customerdto , HttpStatus.OK);
        //return new ResponseEntity<>(new PurchaseOrderResponseDto() , HttpStatus.CREATED);
    }


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\AddressDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

@Data
public class AddressDto
{
    private Long addrId;
    private String hno;
    private String street;
    private String city;
    private String state;
    private String zipCode;
    private String addrType;
    private String deleteSw;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\CartItemDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

@Data
public class CartItemDto
{
    private Integer quantity;
    private double unitprice;
    private  Long productId;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\CustomerDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

import java.time.LocalDate;

@Data
public class CustomerDto
{
    private Long customerId;
    private String name;
    private String email;
    private String password;
    private String pwdUpdated;
    private String phoneNo;

    private LocalDate dateCreated;

    private LocalDate lastUpdated;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\OrderDetailsDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

@Data
public class OrderDetailsDto
{
    private Double totalPrice;
    private Integer totalQuantity;
    private Long customerId;

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\OrderDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

import java.time.LocalDate;

@Data
public class OrderDto {

    private Integer orderId;
    private String orderTrackingNum;
    private Double totalPrice;
    private Integer totalQuantity;
    private String orderStatus;
    private LocalDate deliveyDate;
    private String paymentStatus;
    private String razorpayOrderId;
    private String razorpayPaymentId;
    private LocalDate dateCreated;
    private LocalDate lastUpdated;
    private String customerEmail;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\OrderItemDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

@Data
public class OrderItemDto
{
    private Integer itemId;
    private String imageUrl;
    private Integer quantity;
    private Double unitprice;
    private String productName;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\OrderResponseDto.java ================
package com.ecom.orderapi.dto;

import com.ecom.orderapi.entity.AddressEntity;
import com.ecom.orderapi.entity.CustomerEntity;
import lombok.Data;


import java.time.LocalDate;

@Data
public class OrderResponseDto
{
    private Long orderId;

    private String orderTrackingNum;
    private Double totalPrice;
    private Integer totalQuantity;
    private String orderStatus;
    private LocalDate deliveyDate;
    private String paymentStatus;
    private LocalDate dateCreated;
    private LocalDate lastUpdated;

    private Long  customerId;
    private Long addressId;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\PlaceOrderDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

import java.util.List;

@Data
public class PlaceOrderDto
{
    private Long customerId;
    private Long addressId;
    private OrderDetailsDto orderDetailsDto;
    //private List<OrderItemDto> orderItemDtoList;
    private List<CartItemDto> cartitemdto;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\ProductDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

import java.time.LocalDate;

@Data
public class ProductDto
{
    private Long productId;
    private String name;
    private String description;
    private String title;
    private Double unitPrice;
    private String imageUrl;
    private boolean active;
    private int unitsInStock;

    private LocalDate dateCreated;
    private LocalDate lastUpdated;

    //private ProductCategory category;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\PurchaseOrderRequestDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

import java.util.List;

@Data
public class PurchaseOrderRequestDto
{
    private Long customerId;
    private AddressDto addressDto;
    private OrderDetailsDto orderDetailsDto;
    //private List<OrderItemDto> orderItemDtoList;
    private List<CartItemDto> cartitemdto;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\PurchaseOrderResponseDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

@Data
public class PurchaseOrderResponseDto
{
    private Long orderId;
    private String razorpayOrderId;
    private String orderStatus;
    private String orderTrackingNumber;
    private String paymentStatus;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\dto\UpdateProductDto.java ================
package com.ecom.orderapi.dto;

import lombok.Data;

@Data
public class UpdateProductDto
{
    private  Long productId;
    private Integer quantity;
    private String updateType;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\entity\AddressEntity.java ================
package com.ecom.orderapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
@Table(name = "customer_address")
public class AddressEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long addrId;
    private String hno;
    private String street;
    private String city;
    private String state;
    private String zipCode;
    private String addrType;
    private String deleteSw;
    private String myname;

    @ManyToOne
    @JoinColumn(name = "customer_id")
    private CustomerEntity customer;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\entity\CustomerEntity.java ================
package com.ecom.orderapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDate;

@Entity
@Getter
@Setter
@Table(name = "customer")
public class CustomerEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long customerId;
    private String name;
    private String email;
    private String password;
    private String pwdUpdated;
    private String phoneNo;
    @CreationTimestamp
    @Column(name="date_created", updatable = false)
    private LocalDate dateCreated;

    @UpdateTimestamp
    @Column(name="last_updated", insertable = false)
    private LocalDate lastUpdated;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\entity\OrderEntity.java ================
package com.ecom.orderapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.time.LocalDate;

@Entity
@Setter
@Getter
@Table(name = "orders")
public class OrderEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long orderId;

    private String orderTrackingNum;
    private Double totalPrice;
    private Integer totalQuantity;
    private String orderStatus;
    private LocalDate deliveyDate;
    private String paymentStatus;
    private String razorpayOrderId;
    private String razorpayPaymentId;

    @CreationTimestamp
    @Column(name = "date_created", updatable = false)
    private LocalDate dateCreated;

    @UpdateTimestamp
    @Column(name = "date_updated", insertable = false)
    private LocalDate lastUpdated;

    private String customerEmail;

    @ManyToOne
    @JoinColumn(name = "customer_id")
    private CustomerEntity customer;

    @ManyToOne
    @JoinColumn(name = "addr_id")
    private AddressEntity shippingAddress;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\entity\OrderItemEntity.java ================
package com.ecom.orderapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Entity
@Table(name="order_items")
@Setter
@Getter
public class OrderItemEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long itemId;
    private String imageUrl;
    private Integer quantity;
    private Double unitprice;
    private String productName;
    private Long productId;

    @ManyToOne
    @JoinColumn(name="order_id")
    private OrderEntity order;

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\entity\ProductCategory.java ================
package com.ecom.orderapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Entity
@Table(name = "productcategory")
public class ProductCategory
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long categoryId;

    private String categoryName;

    private String active;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\entity\ProductEntity.java ================
package com.ecom.orderapi.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.time.LocalDate;

@Entity
@Getter
@Setter
@Table(name = "product")
public class ProductEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long productId;
    private String name;
    private String description;
    private String title;
    private Double unitPrice;
    private String imageUrl;
    private boolean active;
    private int unitsInStock;

    @CreationTimestamp
    private LocalDate dateCreated;

    @UpdateTimestamp
    private LocalDate lastUpdated;

    @ManyToOne
    @JoinColumn(name="category_id", nullable = false)
    private ProductCategory category;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\exception\CompileTimeException.java ================
package com.ecom.orderapi.exception;

public class CompileTimeException extends Exception
{
    CompileTimeException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\exception\GenericApiException.java ================
package com.ecom.orderapi.exception;

public class GenericApiException extends RuntimeException
{
    public GenericApiException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\exception\GlobalExceptionHandler.java ================
package com.ecom.orderapi.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler
{
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> myResourceNotFoundException(ResourceNotFoundException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(GenericApiException.class)
    public ResponseEntity<String> myGenericApiException(GenericApiException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(CompileTimeException.class)
    public ResponseEntity<String> myCompileTimeException(CompileTimeException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<String> myValidationError(MethodArgumentNotValidException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> myException(Exception e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\exception\ResourceNotFoundException.java ================
package com.ecom.orderapi.exception;


public class ResourceNotFoundException extends RuntimeException
{
    String resourceName;
    String field;
    String fieldName;
    Integer fieldId;

    public ResourceNotFoundException() {
    }

    public ResourceNotFoundException(String resourceName, String field, String fieldName) {
        super(String.format("%s not found with %s: %s", resourceName, field, fieldName));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldName = fieldName;
    }

    public ResourceNotFoundException(String resourceName, String field, Integer fieldId) {
        super(String.format("%s not found with %s: %d", resourceName, field, fieldId));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldId = fieldId;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\feignclient\CustomerApi_feignclient.java ================
package com.ecom.orderapi.feignclient;

import com.ecom.orderapi.dto.AddressDto;
import com.ecom.orderapi.dto.CustomerDto;
import com.ecom.orderapi.dto.ProductDto;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(name = "CUSTOMERAPI")
public interface CustomerApi_feignclient
{
    @GetMapping("/api/customer/get/customer/{customerId}")
    CustomerDto getCustomerFeign(@PathVariable("customerId") Long customerId);

    @GetMapping("/api/customer/get/logged/customerdetails")
    CustomerDto getCustomerDetailsByHeader();

    @GetMapping("/api/address/delete/address/{addressId}")
    AddressDto getAddressFeign(@PathVariable("addressId") Long addressId);


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\feignclient\ProductApi_feignclient.java ================
package com.ecom.orderapi.feignclient;

import com.ecom.orderapi.dto.ProductDto;
import com.ecom.orderapi.dto.UpdateProductDto;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;

import java.util.List;

@FeignClient(name = "API")
public interface ProductApi_feignclient
{
    @GetMapping("/api/products/get/product/{productId}")
    public ProductDto getProductByProductid(@PathVariable("productId") Long productId);

    @PutMapping("/api/products/update/purchasedproduct")
    public String updateAllProducts(@RequestBody List<UpdateProductDto> allproductsupdate);


}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\repository\AddressRepository.java ================
package com.ecom.orderapi.repository;

import com.ecom.orderapi.entity.AddressEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface AddressRepository extends JpaRepository<AddressEntity ,Long>
{

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\repository\CustomerRepository.java ================
package com.ecom.orderapi.repository;

import com.ecom.orderapi.entity.CustomerEntity;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CustomerRepository extends JpaRepository<CustomerEntity , Long>
{
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\repository\OrderItemRepository.java ================
package com.ecom.orderapi.repository;

import com.ecom.orderapi.entity.OrderItemEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface OrderItemRepository extends JpaRepository<OrderItemEntity ,Long> {
    List<OrderItemEntity> findAllByOrder_OrderId(Long orderId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\repository\OrderRepository.java ================
package com.ecom.orderapi.repository;

import com.ecom.orderapi.entity.OrderEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface OrderRepository extends JpaRepository<OrderEntity , Long>
{

    //List<OrderEntity> findBycustomer_id();

    List<OrderEntity> findByCustomer_CustomerId(Long customerId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\repository\ProductRepository.java ================
package com.ecom.orderapi.repository;


import com.ecom.orderapi.entity.ProductEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ProductRepository extends JpaRepository<ProductEntity, Long> {
    //List<ProductEntity> findByCategoryId();

    //List<ProductEntity> findByProductNameLikeIgnoreCase(String s);

    List<ProductEntity> findByNameLikeIgnoreCase(String s);

    List<ProductEntity> findByCategoryCategoryId(Long categoryId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\service\OrderService.java ================
package com.ecom.orderapi.service;

import com.ecom.orderapi.dto.*;

import java.util.List;

public interface OrderService 
{

    //public PurchaseOrderResponseDto createOrderServ(PurchaseOrderRequestDto purchaseorder);

    public PurchaseOrderResponseDto cancelOrderServ(Long orderId);

    public List<OrderResponseDto> getAllOrdersServ();

    public List<OrderResponseDto> getAllOrdersOfCustomerServ(Long customerId);

    public OrderResponseDto getOrderByOrderIdServ(Long orderId);

    public OrderDto modifyOrderServ(OrderDto orderdto);

    public PurchaseOrderResponseDto placeOrderServ(PlaceOrderDto placeorderdto);

    CustomerDto getCustomerDetails();
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\service\OrderServiceImpl.java ================
package com.ecom.orderapi.service;

import com.ecom.orderapi.dto.*;
import com.ecom.orderapi.entity.*;
import com.ecom.orderapi.exception.GenericApiException;
import com.ecom.orderapi.exception.ResourceNotFoundException;
import com.ecom.orderapi.feignclient.CustomerApi_feignclient;
import com.ecom.orderapi.feignclient.ProductApi_feignclient;
import com.ecom.orderapi.repository.*;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.weaver.ast.Or;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.ui.Model;

import java.util.ArrayList;
import java.util.List;

@Service
@Slf4j
public class OrderServiceImpl implements  OrderService
{
    @Autowired
    private CustomerRepository customerrepo;

    @Autowired
    private OrderRepository orderrepo;

    @Autowired
    private ProductRepository productrepo;

    @Autowired
    private ModelMapper modelmapper;

    @Autowired
    private OrderItemRepository orderItemRepository;

    @Autowired
    private AddressRepository addressrepo;

    @Autowired
    private CustomerApi_feignclient customerfeignclient;

    @Autowired
    private ProductApi_feignclient productfeignclient;


    @Override
    public PurchaseOrderResponseDto cancelOrderServ(Long orderId)
    {
        System.out.println("entered the cancel method for orderId = "+orderId);
        // 1.fetch order details
        OrderEntity orderentity = orderrepo.findById(orderId)
                .orElseThrow(()->new GenericApiException("there is no order with the orderId = "+orderId));
        orderentity.setOrderStatus("CANCELED");
        orderentity.setPaymentStatus("REFUND SUCCESS");
        orderentity.setDeliveyDate(null);

        OrderEntity savedorderentity = orderrepo.save(orderentity);

        PurchaseOrderResponseDto cancelresponse = new PurchaseOrderResponseDto();
        cancelresponse.setOrderTrackingNumber(savedorderentity.getOrderTrackingNum());
        cancelresponse.setPaymentStatus(savedorderentity.getPaymentStatus());
        cancelresponse.setOrderTrackingNumber(savedorderentity.getOrderTrackingNum());
        cancelresponse.setRazorpayOrderId(savedorderentity.getRazorpayOrderId());

        List<OrderItemEntity> allorderitems = orderItemRepository.findAllByOrder_OrderId(orderId);

        System.out.println("these are the orderItems present in the order");
        allorderitems.forEach(System.out::println);

        List<UpdateProductDto> updatepurchasedproducts  = new ArrayList<>();

        allorderitems.forEach(individualorderitem->{
            Long productId = individualorderitem.getProductId();
            Integer quantity = individualorderitem.getQuantity();
            /*
            ProductEntity productentity = productrepo.findById(productId)
                    .orElseThrow(()-> new ResourceNotFoundException("product","productId",""+productId));

                    interservice communication
            */
            ProductDto productdto = productfeignclient.getProductByProductid(productId);
            ProductEntity productentity = modelmapper.map(productdto , ProductEntity.class);

            System.out.println("productquantity after ordering = "+productentity.getUnitsInStock());

            Integer quantityafter = productentity.getUnitsInStock()+quantity;
            System.out.println("productquantity after cancelling = "+quantityafter);
            productentity.setUnitsInStock(quantityafter);
            UpdateProductDto updateproductdto = new UpdateProductDto();
            updateproductdto.setProductId(productId);
            updateproductdto.setQuantity(quantity);
            updateproductdto.setUpdateType("ADD");

            updatepurchasedproducts.add(updateproductdto);

            //ProductEntity savedproduct = productrepo.save(productentity);
            //System.out.println("productquantity after cancelling = "+savedproduct.getUnitsInStock());

        });

        // interservice communication
        productfeignclient.updateAllProducts(updatepurchasedproducts);

        return cancelresponse;
    }

    @Override
    public List<OrderResponseDto> getAllOrdersServ()
    {
        List<OrderEntity> orderentity = orderrepo.findAll();
        List<OrderResponseDto> allorderdtos = orderentity.stream()
                .map(individualorderitem->modelmapper.map(individualorderitem , OrderResponseDto.class))
                .toList();
        return allorderdtos;
    }

    @Override
    public List<OrderResponseDto> getAllOrdersOfCustomerServ(Long customerId)
    {
        //interservice communication checking if the customer is actually present or not
        CustomerDto customerdto = customerfeignclient.getCustomerFeign(customerId);


        List<OrderEntity> orderentity = orderrepo.findByCustomer_CustomerId(customerId);
        List<OrderResponseDto> allorderdtos = orderentity.stream()
                .map(individualorderitem->modelmapper.map(individualorderitem , OrderResponseDto.class))
                .toList();
        return allorderdtos;
    }

    @Override
    public OrderResponseDto getOrderByOrderIdServ(Long orderId)
    {
        OrderEntity orderentity = orderrepo.findById(orderId)
                .orElseThrow(()->new ResourceNotFoundException("order","orderId",""+orderId));

        return modelmapper.map(orderentity , OrderResponseDto.class);
    }



    public String updateProductDetails(PlaceOrderDto placeorderdto)
    {
        List<CartItemDto> allcartitems=placeorderdto.getCartitemdto();
        allcartitems.forEach(individualcartitem->{

        });


        return null;
    }

    @Override
    public PurchaseOrderResponseDto placeOrderServ(PlaceOrderDto placeorderdto)
    {
        // 1.
        Long customerId = placeorderdto.getCustomerId();
        Long addressId = placeorderdto.getAddressId();
        System.out.println("addressId = "+addressId);
        OrderDetailsDto orderdetailsdto = placeorderdto.getOrderDetailsDto();
        List<CartItemDto> cartitemdto = placeorderdto.getCartitemdto();

//===========================================================================================================================================================================================================================
        // 2. getting customer details from customer repo later get from the customerapi using feignclient interservice communication
        /*CustomerEntity customerentity = customerrepo.findById(customerId)
                .orElseThrow(()-> new ResourceNotFoundException("customer","customerId",""+customerId));*/

        // A. calling customerfeignclient
        CustomerDto customerdto = customerfeignclient.getCustomerFeign(customerId);
        CustomerEntity customerentity = modelmapper.map(customerdto,CustomerEntity.class);

        System.out.println("feignclient customer result = "+customerdto);
//===========================================================================================================================================================================================================================
        //3. convert OrderDetailsDto to OrderDto
        OrderDto orderdto = new OrderDto();

        orderdto.setTotalPrice(orderdetailsdto.getTotalPrice());
        orderdto.setTotalQuantity(orderdetailsdto.getTotalQuantity());
        orderdto.setCustomerEmail(customerentity.getEmail());

        OrderEntity orderentity = modelmapper.map(orderdto , OrderEntity.class);
        orderentity.setCustomer(customerentity);

//===========================================================================================================================================================================================================================
        //4. convert List<CartItemDto> to List<OrderItemDto>

      /*  List<OrderItemDto> orderitemdtos = new ArrayList<>();
                cartitemdto.stream()
                .map(individualcartitem->{
                    OrderItemDto orderitemdto = new OrderItemDto();
                    orderitemdto.setImageUrl(null);
                    orderitemdto.setUnitprice(null);
                    orderitemdto.setQuantity(null);
                    orderitemdto.setProductName(null);
                    orderitemdtos.add(orderitemdto);
                })
      */

        List<OrderItemEntity> orderitementities  = new ArrayList<>();

        List<UpdateProductDto> updatepurchasedproducts  = new ArrayList<>();


        cartitemdto.forEach(individualcartitem -> {
            OrderItemEntity orderitementity = new OrderItemEntity();

            ProductDto productdto = productfeignclient.getProductByProductid(individualcartitem.getProductId());
            ProductEntity productentity = modelmapper.map(productdto,ProductEntity.class);

            /*ProductEntity productentity = productrepo.findById(individualcartitem.getProductId())
                    .orElseThrow(()->new ResourceNotFoundException("product","productId",""+individualcartitem.getProductId()));
            */

            orderitementity.setImageUrl(productentity.getImageUrl());
            orderitementity.setUnitprice(productentity.getUnitPrice());
            orderitementity.setQuantity(individualcartitem.getQuantity());
            orderitementity.setProductName(productentity.getName());
            orderitementity.setProductId(productentity.getProductId());
            orderitementity.setOrder(orderentity);
            orderitementities.add(orderitementity);

            // updating the quantity after placing the order

            UpdateProductDto updateproductdto = new UpdateProductDto();
            updateproductdto.setProductId(individualcartitem.getProductId());
            updateproductdto.setQuantity(individualcartitem.getQuantity());
            updateproductdto.setUpdateType("REMOVE");
            updatepurchasedproducts.add(updateproductdto);

            //productentity.setUnitsInStock(productentity.getUnitsInStock()-individualcartitem.getQuantity());
        });

        String message = productfeignclient.updateAllProducts(updatepurchasedproducts);
        System.out.println("after updating purchased products = "+message +" "+updatepurchasedproducts);


//===========================================================================================================================================================================================================================
        /*
               5. check if the address is saved in the customer with the addressId if not saved first save it using
                  feignclient interservice communication
                -> we have to check it in the customerapi
        */

        /*AddressEntity shippingaddress = addressrepo.findById(addressId)
                .orElseThrow(()-> new ResourceNotFoundException("address","addressId",""+addressId));

         */

        // using the customer feignclient

        AddressDto addressdto = customerfeignclient.getAddressFeign(addressId);
        System.out.println("addressdto from customerfeignclient = "+addressdto);
        AddressEntity shippingaddress = modelmapper.map(addressdto , AddressEntity.class);

                //AddressEntity addressentity = modelmapper.map(addressdto , AddressEntity.class);
//===========================================================================================================================================================================================================================
       /*
                6. setting ordertrackingnumber , razorpay details
        */

        orderentity.setRazorpayOrderId("1234");
        orderentity.setOrderTrackingNum("1234");
        orderentity.setPaymentStatus("COMPLETED");
        orderentity.setOrderStatus("CREATED");
        orderentity.setRazorpayPaymentId("1234");
        orderentity.setShippingAddress(shippingaddress);

        OrderEntity savedorderentity = orderrepo.save(orderentity);

 //===========================================================================================================================================================================================================================
        /*
           update the quantity of the product after successfully placing the order
         */


//===========================================================================================================================================================================================================================

        /*
             7.
         */

        System.out.println("orderitementities foreach");

        orderitementities.forEach(individualorderitem->{

            orderItemRepository.save(individualorderitem);
        });

        System.out.println("after orderitementities foreach");
//===========================================================================================================================================================================================================================

        //8.

        PurchaseOrderResponseDto responseDto = new PurchaseOrderResponseDto();
        responseDto.setOrderId(savedorderentity.getOrderId());
        responseDto.setOrderStatus(savedorderentity.getOrderStatus());
        responseDto.setRazorpayOrderId(savedorderentity.getRazorpayOrderId());
        responseDto.setPaymentStatus(savedorderentity.getPaymentStatus());
        responseDto.setOrderTrackingNumber(savedorderentity.getOrderTrackingNum());
//===========================================================================================================================================================================================================================
        return responseDto;


    }

    @Override
    public CustomerDto getCustomerDetails()
    {
        //Long testcustomerId = SecurityContextHolder.getContext().getAuthentication().getPrincipal()();

        try
        {
            Long customerId = Long.valueOf((String) SecurityContextHolder.getContext().getAuthentication().getPrincipal());
            log.info("NATALIE customerId is = "+customerId);
            // A. calling customerfeignclient
           CustomerDto customerdto = customerfeignclient.getCustomerDetailsByHeader();
            log.info("NATALIE  CustomerDto customerdto = "+customerdto);

            return customerdto;
        }
        catch (Exception e)
        {
            log.info("exception occured in the oderserviceimpl = "+e.getMessage());
        }

        return null;

    }

    @Override
    public OrderDto modifyOrderServ(OrderDto orderdto)
    {
        return null;
    }

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\springsecurity\config\SecurityConfig.java ================
package com.ecom.orderapi.springsecurity.config;


import com.ecom.orderapi.springsecurity.filter.GatewayAuthenticationFilter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Slf4j
@EnableMethodSecurity(prePostEnabled = true)
@Configuration
public class SecurityConfig
{
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, GatewayAuthenticationFilter gatewayAuthenticationFilter) throws Exception
    {
        log.info("NATALIE control entered securityFilterChain ");
            http.csrf(csrf -> csrf.disable())
                .sessionManagement(sm ->
                                           sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS) )
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(gatewayAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

            return http.build();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\springsecurity\filter\GatewayAuthenticationFilter.java ================
package com.ecom.orderapi.springsecurity.filter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Component
public class GatewayAuthenticationFilter extends OncePerRequestFilter
{
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException
    {
        log.info("NATALIE control entered doFilterInternal");

        String userId = request.getHeader("X-User-Id");
        log.info("NATALIE control entered doFilterInternal");

        String authoritiesHeader = request.getHeader("X-User-Authorities");
        log.info("NATALIE control entered doFilterInternal");

        if (userId != null && authoritiesHeader != null)
        {
            /*
            List<SimpleGrantedAuthority> authorities =
                    Arrays.stream(authoritiesHeader.split(","))
                            .map(String::trim)
                            .map(SimpleGrantedAuthority::new)
                            .toList();
             */
            List<SimpleGrantedAuthority> authorities = new ArrayList<>();

            String[] authorityArray = authoritiesHeader.split(",");

            for (String authority : authorityArray) {
                String cleaned = authority.trim();
                SimpleGrantedAuthority grantedAuthority =
                        new SimpleGrantedAuthority(cleaned);

                authorities.add(grantedAuthority);
            }


            log.info("NATALIE List<SimpleGrantedAuthority> authorities = "+authorities);

            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userId, null, authorities);
            log.info("NATALIE authentication object created is = "+authentication);

            SecurityContextHolder.getContext().setAuthentication(authentication);
            log.info("NATALIE execution of doFilterInternal is completed and authentiction object in the securitycontextholder is ="+SecurityContextHolder.getContext().getAuthentication());

        }
        filterChain.doFilter(request, response);

    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\java\com\ecom\orderapi\springsecurity\interceptor\FeinClientInterceptor.java ================
package com.ecom.orderapi.springsecurity.interceptor;

import feign.RequestInterceptor;
import feign.RequestTemplate;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Set;
import java.util.stream.Collectors;

@Slf4j
@Component
public class FeinClientInterceptor implements RequestInterceptor
{
    @Override
    public void apply(RequestTemplate requestTemplate)
    {
        log.info("NATALIE control entered the FeinClientInterceptor");
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        log.info("NATALIE authentication object is = "+authentication);


        if(authentication != null)
        {
            try
            {
                String testuserId = (String)authentication.getPrincipal();
                Long userId = Long.valueOf(testuserId);

                requestTemplate.header("X-User-Id", userId.toString());
                log.info("NATALIE userId = "+userId);
            }
            catch(Exception e)
            {
                log.info("exception occured in the feignclientinterceptor "+e.getMessage());
            }




            //Collection<? extends GrantedAuthority> authorities = authentication.getAuthorities();

            //  Converting authorities to Set<String>
            Set<String> authoritiesOfUser = authentication.getAuthorities().stream()
                                                                .map(GrantedAuthority::getAuthority)
                                                                .collect(Collectors.toSet());
            log.info("NATALIE converting Collection<? extends GrantedAuthority> authorities to Set<String> = "+authoritiesOfUser);

            //  Joining authorities using comma
            String authoritiesHeader = String.join(",", authoritiesOfUser);
            log.info("NATALIE converting Set<String> to string "+authoritiesHeader);

            // Adding header
            requestTemplate.header("X-User-Authorities", authoritiesHeader);


        }
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\main\resources\application.properties ================
spring.application.name=orderapi

#spring.datasource.url=jdbc:mysql://host.docker.internal:3306/latest_microservices_ecommerce_db
#spring.datasource.username=root
#spring.datasource.password=Nvr144@144
#spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# ===============================
# DATABASE (PostgreSQL - Docker)
# ===============================
spring.datasource.url=jdbc:postgresql://microservice-db:5432/microservicedb
spring.datasource.username=user
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

server.port=7005

eureka.instance.prefer-ip-address=true

eureka.client.service-url.defaultZone=http://eurekaserver:8761/eureka


================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\orderapi\src\test\java\com\ecom\orderapi\OrderapiApplicationTests.java ================
package com.ecom.orderapi;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class OrderapiApplicationTests {

	@Test
	void contextLoads() {
	}

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\Dockerfile ================
FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY target/*.jar app.jar

EXPOSE 7001

ENTRYPOINT ["java","-jar","app.jar"]

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\pom.xml ================
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>4.0.1</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.product</groupId>
	<artifactId>api</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>api</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>17</java.version>
		<spring-cloud.version>2025.1.0</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-webmvc</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>

		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-actuator</artifactId>
		</dependency>

		<dependency>
			<groupId>org.modelmapper</groupId>
			<artifactId>modelmapper</artifactId>
			<version>3.2.2</version>
		</dependency>

		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.13</version>
		</dependency>

		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>


		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-brave</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin</artifactId>
		</dependency>
		<dependency>
			<groupId>io.micrometer</groupId>
			<artifactId>micrometer-tracing-bridge-brave</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-micrometer-tracing-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-zipkin-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security-test</artifactId>
			<scope>test</scope>
		</dependency>

	</dependencies>



	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\.mvn\wrapper\maven-wrapper.properties ================
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\ApiApplication.java ================
package com.product.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
public class ApiApplication
{
	public static void main(String[] args)
	{
		SpringApplication.run(ApiApplication.class, args);
	}
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\config\modelmapperconfig.java ================
package com.product.api.config;

import org.modelmapper.ModelMapper;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class modelmapperconfig
{
    @Bean
    public ModelMapper getmodelmapper()
    {
        return new ModelMapper();
    }

}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\controller\ProductController.java ================
package com.product.api.controller;

import com.product.api.dto.CategoryDto;
import com.product.api.dto.ProductDto;
import com.product.api.dto.UpdateProductDto;
import com.product.api.entity.ProductCategory;
import com.product.api.exception.ResourceNotFoundException;
import com.product.api.repository.CategoryRepository;

import com.product.api.service.ProductService;
import lombok.extern.slf4j.Slf4j;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/products")
public class ProductController
{
    @Autowired
    private ProductService productservice;

    @Autowired
    private CategoryRepository catrepo;

    @Autowired
    private ModelMapper modelmapper;

    @GetMapping("/get/allproducts")
    //@PreAuthorize("hasRole('ADMIN') and hasAuthority('PRODUCT_VIEW')")
    public ResponseEntity<List<ProductDto>> getAllProducts()
    {
        log.info("NATALIE control entered the getAllProducts()");


        List<ProductDto> allproducts = productservice.getAllProducts();
        return new ResponseEntity<>(allproducts , HttpStatus.OK);
    }

    @GetMapping("/get/products/{categoryId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('PRODUCT_VIEW')")
    public ResponseEntity<List<ProductDto>> getAllProductsByCategory(@PathVariable Long categoryId)
    {


        List<ProductDto> allproducts = productservice.getAllProductsbyCategory(categoryId);
        return new ResponseEntity<>(allproducts , HttpStatus.OK);
    }

    @GetMapping("/search")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('PRODUCT_VIEW')")
    public ResponseEntity<List<ProductDto>> searchProductByName(String keyword)
    {


        List<ProductDto> allproducts = productservice.findProductByName('%' + keyword + '%');
        return new ResponseEntity<>(allproducts , HttpStatus.OK);
    }

    @PostMapping("/add/product/{categoryId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN') and hasAuthority('PRODUCT_CREATE')")
    public  ResponseEntity<ProductDto> createProduct(@RequestBody  ProductDto productdto ,@PathVariable Long categoryId)
    {

        ProductDto productdtocreated = productservice.createProduct(productdto , categoryId);
        return new ResponseEntity<>(productdtocreated , HttpStatus.OK);
    }

    @DeleteMapping("/delete/{productId}")
    @PreAuthorize("hasAnyRole('SELLER','ADMIN') and hasAuthority('PRODUCT_DELETE')")
    public  ResponseEntity<String> deleteProduct(@PathVariable Long productId)
    {

        productservice.deleteProduct(productId);
        return new ResponseEntity<>("success" , HttpStatus.OK);
    }

    @PostMapping("/create/category/")
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('CATEGORY_CREATE')")
    public  ResponseEntity<CategoryDto> createCategory(@RequestBody CategoryDto categorydto)
    {

        CategoryDto productdtocreated = productservice.createCategory(categorydto );
        return new ResponseEntity<>(productdtocreated , HttpStatus.OK);
    }

    @GetMapping("/get/all/categories")
    @PreAuthorize("hasAnyRole('USER','ADMIN','SELLER') and hasAuthority('CATEGORY_VIEW')")
    public ResponseEntity<List<CategoryDto>> getAllCategories()
    {

        List<ProductCategory> allcategoryentity = catrepo.findAll();
        List<CategoryDto> allcategorydtos=allcategoryentity.stream()
                .map(individualCategoryentity -> modelmapper.map(individualCategoryentity , CategoryDto.class))
                .toList();

        return new ResponseEntity<>(allcategorydtos , HttpStatus.OK);
    }

    @GetMapping("/get/category/byid/{categoryId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN','SELLER') and hasAuthority('CATEGORY_VIEW')")
    public ResponseEntity<CategoryDto> getCategorybyId(@PathVariable Long categoryId)
    {

        ProductCategory categoryentity = catrepo.findById(categoryId)
                .orElseThrow(()-> new ResourceNotFoundException("category","categoryId",""+categoryId));

        CategoryDto categorydto = modelmapper.map(categoryentity , CategoryDto.class);

        return new ResponseEntity<>(categorydto , HttpStatus.OK);
    }

    @GetMapping("/get/product/{productId}")
    @PreAuthorize("hasAnyRole('USER','ADMIN','SELLER') and hasAuthority('POST_VIEW')")
    public ResponseEntity<ProductDto> getProduct(@PathVariable Long productId)
    {

        ProductDto productdto = productservice.getProductByproductId(productId);
        return new ResponseEntity<>(productdto , HttpStatus.OK);
    }

    @PutMapping("/update/purchasedproduct")
    @PreAuthorize("hasAnyRole('SELLER','ADMIN') and hasAuthority('POST_VIEW')")
    public ResponseEntity<String> updateProduct( @RequestBody List<UpdateProductDto> updateproductdto)
    {

        System.out.println("control entered the product controller");
        String message  = productservice.updateProduct(updateproductdto);
        return new ResponseEntity<>(message , HttpStatus.OK);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\dto\CategoryDto.java ================
package com.product.api.dto;

import lombok.Data;

@Data
public class CategoryDto
{
    private Long categoryId;
    private String categoryName;
    private String active;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\dto\ProductDto.java ================
package com.product.api.dto;

import com.product.api.entity.ProductCategory;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDate;

@Data
public class ProductDto
{
    private Long productId;
    private String name;
    private String description;
    private String title;
    private Double unitPrice;
    private String imageUrl;
    private boolean active;
    private int unitsInStock;

    private LocalDate dateCreated;
    private LocalDate lastUpdated;

    //private ProductCategory category;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\dto\UpdateProductDto.java ================
package com.product.api.dto;

import lombok.Data;

@Data
public class UpdateProductDto
{
    private  Long productId;
    private Integer quantity;
    private String updateType;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\entity\ProductCategory.java ================
package com.product.api.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Entity
@Table(name = "productcategory")
public class ProductCategory
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long categoryId;

    private String categoryName;

    private String active;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\entity\ProductEntity.java ================
package com.product.api.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.time.LocalDate;

@Entity
@Getter
@Setter
@Table(name = "product")
public class ProductEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long productId;
    private String name;
    private String description;
    private String title;
    private Double unitPrice;
    private String imageUrl;
    private boolean active;
    private int unitsInStock;

    @CreationTimestamp
    private LocalDate dateCreated;

    @UpdateTimestamp
    private LocalDate lastUpdated;

    @ManyToOne
    @JoinColumn(name="category_id", nullable = false)
    private ProductCategory category;
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\exception\GenericApiException.java ================
package com.product.api.exception;

public class GenericApiException extends RuntimeException
{
    public GenericApiException(String message)
    {
        super(message);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\exception\GlobalExceptionHandler.java ================
package com.product.api.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler
{

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<String> myMethodArgumentNotValidException(MethodArgumentNotValidException e)
    {
        //String message = "code check chey bey error vachindi  MethodArgumentNotValidException ";
        String message = e.getDetailMessageCode();

        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(GenericApiException.class)
    public ResponseEntity<String> myMethodArgumentNotValidException(GenericApiException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }


    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<String> myResourceNotFoundException(ResourceNotFoundException e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<String> myApiGenericException(Exception e)
    {
        String message = e.getMessage();
        return new ResponseEntity<>(message , HttpStatus.BAD_REQUEST);
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\exception\ResourceNotFoundException.java ================
package com.product.api.exception;

public class ResourceNotFoundException extends RuntimeException
{
    String resourceName;
    String field;
    String fieldName;
    Integer fieldId;

    public ResourceNotFoundException() {
    }

    public ResourceNotFoundException(String resourceName, String field, String fieldName) {
        super(String.format("%s not found with %s: %s", resourceName, field, fieldName));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldName = fieldName;
    }

    public ResourceNotFoundException(String resourceName, String field, Integer fieldId) {
        super(String.format("%s not found with %s: %d", resourceName, field, fieldId));
        this.resourceName = resourceName;
        this.field = field;
        this.fieldId = fieldId;
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\repository\CategoryRepository.java ================
package com.product.api.repository;

import com.product.api.entity.ProductCategory;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CategoryRepository extends JpaRepository<ProductCategory , Long> {
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\repository\ProductRepository.java ================
package com.product.api.repository;

import com.product.api.dto.ProductDto;
import com.product.api.entity.ProductEntity;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ProductRepository extends JpaRepository<ProductEntity, Long> {
    //List<ProductEntity> findByCategoryId();

    //List<ProductEntity> findByProductNameLikeIgnoreCase(String s);

    List<ProductEntity> findByNameLikeIgnoreCase(String s);

    List<ProductEntity> findByCategoryCategoryId(Long categoryId);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\security\jwt\config\SecurityConfig.java ================
package com.product.api.security.jwt.config;

import com.product.api.security.jwt.filter.GatewayAuthenticationFilter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Slf4j
@EnableMethodSecurity(prePostEnabled = true)
@Configuration
public class SecurityConfig
{
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, GatewayAuthenticationFilter gatewayAuthenticationFilter) throws Exception
    {
        log.info("NATALIE control entered securityFilterChain ");
            http.csrf(csrf -> csrf.disable())
                .sessionManagement(sm ->
                                           sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS) )
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(gatewayAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

            return http.build();
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\security\jwt\filter\GatewayAuthenticationFilter.java ================
package com.product.api.security.jwt.filter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

@Slf4j
@Component
public class GatewayAuthenticationFilter extends OncePerRequestFilter
{
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException
    {
        log.info("NATALIE control entered doFilterInternal");

        String userId = request.getHeader("X-User-Id");
        log.info("NATALIE control entered doFilterInternal");

        String authoritiesHeader = request.getHeader("X-User-Authorities");
        log.info("NATALIE control entered doFilterInternal");

        if (userId != null && authoritiesHeader != null)
        {

            List<SimpleGrantedAuthority> authorities =
                    Arrays.stream(authoritiesHeader.split(","))
                            .map(String::trim)
                            .map(SimpleGrantedAuthority::new)
                            .toList();

            /*List<SimpleGrantedAuthority> authorities = new ArrayList<>();

            String[] authorityArray = authoritiesHeader.split(",");

            for (String authority : authorityArray) {
                String cleaned = authority.trim();
                SimpleGrantedAuthority grantedAuthority =
                        new SimpleGrantedAuthority(cleaned);

                authorities.add(grantedAuthority);
            }*/


            log.info("NATALIE List<SimpleGrantedAuthority> authorities = "+authorities);

            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userId, null, authorities);
            log.info("NATALIE authentication object created is = "+authentication);

            SecurityContextHolder.getContext().setAuthentication(authentication);
            log.info("NATALIE execution of doFilterInternal is completed and authentiction object in the securitycontextholder is ="+SecurityContextHolder.getContext().getAuthentication());

        }
        filterChain.doFilter(request, response);

    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\service\ProductService.java ================
package com.product.api.service;

import com.product.api.dto.CategoryDto;
import com.product.api.dto.ProductDto;
import com.product.api.dto.UpdateProductDto;

import java.util.List;

public interface ProductService
{
    public List<ProductDto> getAllProducts();
    public List<ProductDto> getAllProductsbyCategory(Long CategoryId);
    public ProductDto createProduct(ProductDto productdto , Long CategoryId);
    public  void deleteProduct(Long productId);

    List<ProductDto> findProductByName(String s);

    CategoryDto createCategory(CategoryDto categorydto);

    ProductDto getProductByproductId(Long productId);

    String updateProduct(List<UpdateProductDto> updateproductdto);
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\java\com\product\api\service\ProductServiceImpl.java ================
package com.product.api.service;

import com.product.api.dto.CategoryDto;
import com.product.api.dto.ProductDto;
import com.product.api.dto.UpdateProductDto;
import com.product.api.entity.ProductCategory;
import com.product.api.entity.ProductEntity;
import com.product.api.exception.ResourceNotFoundException;
import com.product.api.repository.CategoryRepository;
import com.product.api.repository.ProductRepository;
import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
public class ProductServiceImpl implements ProductService
{
    @Autowired
    private ProductRepository productrepo;

    @Autowired
    private CategoryRepository catrepo;

    @Autowired
    private ModelMapper modelmapper;

    @Override
    public List<ProductDto> getAllProducts()
    {
        System.out.println("control entered getAllProducts() ");
        List<ProductEntity> allproductentities = productrepo.findAll();
        List<ProductDto> allproductdtos = allproductentities.stream()
                .map(individualproductentity->modelmapper.map(individualproductentity,ProductDto.class))
                .toList();
        return allproductdtos;
    }

    @Override
    public List<ProductDto> getAllProductsbyCategory(Long categoryId)
    {
        System.out.println("control entered getAllProductsbyCategory() "+categoryId);
        ProductCategory productcategory = catrepo.findById(categoryId)
                .orElseThrow(()-> new ResourceNotFoundException("category","categoryId" , ""+categoryId));
        List<ProductEntity>  allproductentity = productrepo.findByCategoryCategoryId(categoryId);

        allproductentity.forEach(System.out::println);

        List<ProductDto> allproductsdto = allproductentity.stream()
                .map(individualproductentity -> modelmapper.map(individualproductentity , ProductDto.class))
                .toList();

        System.out.println("printing all products of the category");
        allproductsdto.forEach(System.out::println);

        return allproductsdto;

    }

    @Override
    public ProductDto createProduct(ProductDto productdto , Long categoryId)
    {
        System.out.println("control entered createproduct() "+productdto);
        ProductCategory productcategory = catrepo.findById(categoryId)
                .orElseThrow(()-> new ResourceNotFoundException("category","categoryId" , ""+categoryId));

        ProductEntity productentity = modelmapper.map(productdto , ProductEntity.class);
        productentity.setCategory(productcategory);
        ProductEntity savedproductentity =productrepo.save(productentity);

        ProductDto productdtosaved = modelmapper.map(savedproductentity , ProductDto.class);

        System.out.println("savedproduct =  "+productdtosaved);

        return productdtosaved;
    }

    @Override
    public void deleteProduct(Long productId)
    {
        ProductCategory productcategory = catrepo.findById(productId)
                .orElseThrow(()-> new ResourceNotFoundException("product","productId" , ""+productId));
        productrepo.deleteById(productId);

    }

    @Override
    public List<ProductDto> findProductByName(String keyword)
    {
        System.out.println("control entered findProductByName() "+keyword);

        List<ProductEntity> allproducts = productrepo.findByNameLikeIgnoreCase('%' + keyword + '%');

        allproducts.forEach(System.out::println);

        List<ProductDto> allproductsdto = allproducts.stream()
                .map(individualentity -> modelmapper.map(individualentity , ProductDto.class))
                .toList();

        System.out.println("printing all prodycts by name ");
        allproductsdto.forEach(System.out::println);

        return allproductsdto;

    }

    @Override
    public CategoryDto createCategory(CategoryDto categorydto)
    {
        ProductCategory categoryentity = modelmapper.map(categorydto , ProductCategory.class);
        ProductCategory categoryentitysaved = catrepo.save(categoryentity);

        return modelmapper.map(categoryentitysaved , CategoryDto.class);
    }

    @Override
    public ProductDto getProductByproductId(Long productId)
    {
        ProductEntity productentity = productrepo.findById(productId)
                .orElseThrow(()->new ResourceNotFoundException("product","productId",""+productId));
        return modelmapper.map(productentity , ProductDto.class);
    }

    @Override
    public String updateProduct(List<UpdateProductDto> updateproductdtos)
    {
        System.out.println("updateProduct() called, list = " + updateproductdtos);


        updateproductdtos.forEach(individualproductentity->{

            System.out.println("control entered  individualproductentity foreach");

            Long productId = individualproductentity.getProductId();
            ProductEntity productentity = productrepo.findById(productId)
                    .orElseThrow(()->new ResourceNotFoundException("product","productId",""+productId));

            Integer existingquantity = productentity.getUnitsInStock();

            Integer quantity = individualproductentity.getQuantity();
            String updateType = individualproductentity.getUpdateType();

            if(updateType.equals("ADD"))
            {
                productentity.setUnitsInStock(existingquantity + quantity);
            }
            else if(updateType.equals("REMOVE"))
            {

                productentity.setUnitsInStock(existingquantity - quantity);
                System.out.println("control entered REMOVE and quantity is = "+(existingquantity - quantity));
            }

            productrepo.save(productentity);

        });

        System.out.println("success");

        return "success";
    }
}

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\main\resources\application.properties ================
spring.application.name=api


#spring.datasource.url=jdbc:mysql://host.docker.internal:3306/latest_microservices_ecommerce_db
#spring.datasource.username=root
#spring.datasource.password=Nvr144@144
#spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# ===============================
# DATABASE (PostgreSQL - Docker)
# ===============================
spring.datasource.url=jdbc:postgresql://microservice-db:5432/microservicedb
spring.datasource.username=user
spring.datasource.password=password
spring.datasource.driver-class-name=org.postgresql.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

server.port=7001

eureka.instance.prefer-ip-address=true

eureka.client.service-url.defaultZone=http://eurekaserver:8761/eureka

================ FILE: C:\Users\varshith reddy\Desktop\projects\amazon-ecommerce\productapi\src\test\java\com\product\api\ApiApplicationTests.java ================
package com.product.api;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ApiApplicationTests {

	@Test
	void contextLoads() {
	}

}

